<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>xzell ซื้อ-ขายออนไลน์ได้อย่างปลอดภัย</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!--script src="https://bitwiseshiftleft.github.io/sjcl/sjcl.js"></script-->
<script src="https://cdn.jsdelivr.net/npm/crypto-js@4.2.0/crypto-js.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/js-sha256@0.9.0/build/sha256.min.js"></script>
<script src="/devsk/config.js"></script>
<script src="/js/projex.js"></script>
<script src="/js/nodex-b.js"></script>
<script src="/js/xdev-b.js"></script>

<link href="/js/w3.css" rel="stylesheet" type="text/css">
<link href="/js/projex.css" rel="stylesheet" type="text/css">
<link href="/js/material-x.css" rel="stylesheet" type="text/css">

<style>

  /* layout */
  body { background-color: white /*var(--grey-200);*/ }
  .mother { 
    max-width: 1500px; 
    display: grid; 
    grid-template-columns: 100%;
    margin: 0 auto;
  }
  .left-part { display: none; height: 100vh; }
  .right-part { display: none; height: 100vh; }
  .center-part {
    width: 100%;
    height: 100vh;
    padding: 0 16px;
  }

  /* font */
  html { font-size: 16px }
  p, li, span, input, option { font-size: 1.1rem }
  label { font-size: 0.9rem;}
  button { font-size: 0.8rem }
  label { font-family: Ubuntu Condensed; color: var(--indigo-400)}
  h1 { font-size: 2rem; font-family: Ubuntu Condensed; color: darkred; }
  h2 { font-size: 1.75rem; font-family: Ubuntu Condensed; }
  h3 { font-size: 1.5rem; font-family: Ubuntu Condensed; }
  h4 { font-size: 1.25rem; font-family: Ubuntu Condensed; }
  a { color: #0000ff; text-decoration: underline;}
  a:link { color: #0000ff }
  a:visited { color: #0000ff }
  a:hover { color: #0000cc; text-decoration: none; }
  a:active { color: #000099 }

  .product-show { display: grid; grid-template-columns: auto auto; gap: 6px; margin-top: 16px }
  .product-show > div { 
    aspect-ratio: 1/1; cursor: pointer; position: relative;
  }
  .product-show img {
    width: 100%; height: 100%; object-fit: cover;
  }
  .text-on-pic { font-size: 1.3rem; position: absolute; left: 0; bottom: 0; padding: 0; margin: 0; background-color: rgba(255,255,255,0.3); line-height: 1.0; padding-right: 4px;}
  .xz-tag { font-size: 0.8rem; position: absolute; bottom: 0; right: 0 }
  .xz-star { position: absolute; top: 0; right: 0; width: 24px; height: 24px;}

  #nav_content > div { cursor: pointer; flex: 1; display: flex; align-items: center; padding: 0 16px; width: 100%; text-align: left; box-sizing: border-box; }
  #nav_content > div:hover { background-color: var(--grey-300); }


  @media (min-width: 600px) { /* tablet-portrait */
    .product-show {
      grid-template-columns: auto auto auto;
    }
    /* shows 3 pics */
    .product-show > div {
      aspect-ratio: 4/3
    }
  }

  @media (min-width: 1024px) { /* tablet-wide, laptop */
    .product-show { 
      grid-template-columns: auto auto auto auto;
    }
    /* shows 4 pics */
    /*.product-show > div {
      aspect-ratio: 4/3
    }*/
  }

  @media (min-width: 1280px) { /* desktop, large PC */
    .product-show {
      grid-template-columns: auto auto auto auto auto;
    }
    /* shows 5 pics */
  }

  /* we set max-width to 15000 so won't do more than that. */

</style>
</head>
<body>

<!-- userName -->
<span id="user_name" style="position: fixed; top: 0; right: 4px; font-size: 1rem; color: var(--indigo-400); font-family: monospace;" class="x-level-pretop">@guest</span>

<div class="mother">
  <div class="left-part"></div>


  <!--main part-->
  <div class="center-part" >

    <!-- xzell home --
    <div style="font-size: 1rem"><a href="/xzell/index.html" style="text-decoration: none; color: black">xzell</a></div-->

    <!-- screen name -->
    <h1 style="text-align: center;" class="gloria x-bold">xzell</h1>

    <p style="text-align: center; font-size: 0.9rem; color: grey">ซื้อ-ขายออนไลน์ได้อย่างสบายใจ เพราะจ่ายเงินเมื่อได้รับและพอใจในสินค้าแล้วเท่านั้น <span class="x-round x-border x-plr8 x-black x-pointer mat-grey3" style="font-size: 1rem; border: 1px lightgrey solid;" onclick="location.href='join.html';">join</span></p>


    <!-- search -->
    <div id="search_space" class="x-mt24">
      <div style="display: grid; grid-template-columns: 80% 20%;">
        <input id="find_input" type="text" class="w3-input w3-border x-round-14" placeholder="สินค้า/ร้านค้า...">
        <button class="w3-button w3-blue w3-ripple x-round-23" onclick="findProduct( find_input.value)"><img src="/icon/search.svg" class="x-wh24"></button>
      </div>
    </div>

    <!-- search option -->
    <div id="search_option" style="display: grid; grid-template-columns: auto; margin-top: 16px">

      <div id="search_icon_wrap" class="x-pointer" style="display: inline-block"  onclick="switchToggle( this.children[0] )">
        <img id="setup_icon" src="/icon/down.svg" class="x-wh24"> Option
      </div>

      <div id="search_option_space" class="x-background" style="padding: 16px" hidden>
        <div><img src="/icon/off.svg" class="x-wh32"> New Products Only</div>
        <div class="x-mt8"><img src="/icon/off.svg" class="x-wh32"> New Vendors Only</div>
        <div class="x-mt8"><img src="/icon/off.svg" class="x-wh32"> Promotion Items Only</div>
        <div class="x-mt8">
          This Brand Only: 
          <div style="display: grid; grid-template-columns: 80% auto;">
            <input type="text" class="w3-input">
            <button class="w3-button w3-grey">GO</button>
          </div>
        </div>
        <div class="x-mt8">
          This Category Only: 
          <div style="display: grid; grid-template-columns: 80% auto;">
            <input type="text" class="w3-input">
            <button class="w3-button w3-grey">GO</button>
          </div>
        </div>
        <div class="x-mt8">
          From this Country Only:
          <div style="display: grid; grid-template-columns: 80% auto;">
            <input type="text" class="w3-input">
            <button class="w3-button w3-grey">GO</button>
          </div>
        </div>
        <div class="x-mt8">
          Price Range:
          <div style="display: grid; grid-template-columns: 80% auto;">
            <input type="text" class="w3-input">
            <button class="w3-button w3-grey">GO</button>
          </div>
        </div>
      </div>
    </div>
    


    <!-- show products here -->
    <div class="product-show"></div>



    <!-- space at the bottom -->
    <div style="height: 60px;"></div>


    <!-- feature stuff -------------------------------------------->

    <!-- modal / show full pic -->
    <div  id="show_full_pic" 
          style="width: 100vw; height: 100vh; background-color: black; display: none; justify-content: center; align-items: center; position: fixed; left: 0; top: 0"
          class="x-level-pretop">
      <div style="position: relative;" class="level-top">
        <div style="color: white; padding: 8px">
          <h4><span xzell-name></span> (#<span xzell-code></span>) by @<span xzell-by></span></h4>

          <div syle="font-size: 1.35rem"><span xzell-price></span> <span xzell-currency></span> / <span xzell-uom></span></div>
          
          <div class="x-mt x-white" style="display: flex; flex-wrap: wrap; align-items: center;">
            <span class="x-condensed x-pr">QTY</span>
            <input id="full_pic_qty" value="1" type="number" style="text-align: center; background-color: white; width: 100px; font-size: 1.35rem">
            <button onclick="sendOrder()" class="w3-blue w3-button" style="padding: 8px">ORDER</button>
          </div>

        </div>
        <img id="pic_to_show" src="" style="width: 100%; max-height: 100%; object-fit: contain;">
        <div style="display: inline-block; padding: 8px; cursor: pointer;" onclick="document.querySelector('#show_full_pic').style.display = 'none';">
          <img src="/icon/x-grey.svg" class="x-wh32">
        </div>
        <!--span style="position: absolute; top: 8px; left: 8px; background-color: rgba(255,255,255,0.5);" class="x-round">@foods4you #444</span-->
      </div>
    </div>



  </div>


  <div class="right-part"></div>
</div>


<!-- nav / slide from left edge -->
<div  id="nav_icon" 
      style="display: inline-block; padding: 0; cursor: pointer; position: fixed; left: 0; bottom: 0" 
      class="x-level-mid" 
      onclick="nav_box.style.display = 'flex';">
  <img src="/icon-svgrepo/hamburger-menu-svgrepo-com.svg" class="x-wh32">
</div>

<div  id="nav_box" 
      style="position: fixed; bottom: 0; left: 0; width: 80%; height: 100vh; animation: x-slideRightFromLeftEdge 1s forwards; background-color: var(--grey-600); display: none; flex-direction: column;" 
      class="x-round-23 x-level-pretop w3-card">

  <!-- nav content -->
  <div  id="nav_content" 
        style="display: flex; flex-direction: column; flex-grow: 1; font-size: 1.35rem; align-items: center; flex-grow: 1; overflow-y: auto; justify-content: left;">
    <div onclick="location.href = 'join.html'; nav_box.style.display = 'none';"><img src="/icon-x/Profile.svg" class="x-wh40"> &nbsp; Join</div>
    <div onclick="location.href = 'log-in.html'; nav_box.style.display = 'none';"><img src="/icon-x/SignIn.svg" class="x-wh40"> &nbsp; Log-in</div>
    <div><img src="/icon-x/TicketPrice.svg" class="x-wh40"> &nbsp; My Selling</div>
    <div><img src="/icon-x/Basket.svg" class="x-wh40"> &nbsp; My Buying</div>

    <div 
      class="x-wh40"
      onclick="nav_box.style.display = 'none'; gotoUrl( conf.nodexUrl + '/xzell/@' + sessionStorage.userName, 'need-xwt')"><img src="/icon-x/Bike.svg"> &nbsp; My Home
    </div>
    
    <div><img src="/icon-x/Windows.svg" class="x-wh40"> &nbsp; More ...</div>
    <div><img src="/icon-x/Settings.svg" class="x-wh40"> &nbsp; My Setting</div>
    <div onclick="logoutXzell(); nav_box.style.display = 'none';"><img src="/icon-x/SignOut.svg" class="x-wh40"> &nbsp; Log-out</div>
  </div>

  <!-- close nav -->
  <div style="margin-top: 16px; cursor: pointer;" onclick="nav_box.style.display = 'none';" class="x-condensed">
    <img src="/icon-x/X.svg" class="x-wh40"> CLOSE
  </div>

</div>


<!--indicators / basket-->
<div id="top_indicator" 
  class=""
  style="position: fixed; top: 4px; left: 4px; padding: 0">
  
  <!-- full screen / exit -->
  <img src="/icon-x/Square-lg.svg" style="width: 24px" onclick="fullScreen()">

  
  <!--div hidden
  class="x-round x-pointer" 
  style="display: flex; gap: 4px; align-items: center; background-color: rgba(255,255,255,0.5); padding: 0 4px; ">
    <img src="/icon-svgrepo/creadit-card-debit-hand-svgrepo-com.svg" width="24px">
    <span style="font-size: 0.8rem">4</span>
  </div-->
</div>



<script>
////////////////////////////////////////////////////////////////////

// if mobile screen, makes full screen
function fullScreen() {
  if (!document.fullscreenElement) {
    document.documentElement.requestFullscreen()
  } else {
    document.exitFullscreen()
  }
}

/*
if (window.matchMedia('(max-width: 768px)').matches) {
  const el = document.documentElement;

  function enterFullscreen(e) {
    // Only respond if the event target is actually interactable
    if (!(e.target instanceof HTMLElement)) return;

    // Try fullscreen
    el.requestFullscreen?.()
      .then(() => console.log('Fullscreen entered'))
      .catch(err => console.warn('Fullscreen failed:', err));
  }

  // Attach to the document body, not document
  document.body.addEventListener('click', enterFullscreen, { once: true, passive: true });
}
*/










nodex.checkJwt5()
//check query
/*if (window.location.search.length > 0) {
  const params = new URLSearchParams(window.location.search)

  if (params.has('jwt5')) {
    let jwt = nodex.readJwt5( params.get('jwt5'))
    let userName = nodex.readJwtPayload(jwt).userName
    sessionStorage.setItem('jwt',jwt)
    sessionStorage.setItem('userName', userName)
    nodex.clearUrlBar('jwt5')
  }
}
*/

//check userName and display it
if (sessionStorage.userName && sessionStorage.userName != 'guest') {
  user_name.textContent = '@' + sessionStorage.userName
}




const xzellHome = {}
findProduct('*')

/*
loadProduct()

function loadProduct() {
  //load product info and show pic on screen

  nodex.post( conf.nodexUrl + '/xzell/get-product', {})
  .then( productInfo => {
    productInfo.attach.allPicFileName.forEach( fileName => {

      //show each pic
      let newDiv = document.createElement('div')
      newDiv.innerHTML = `<img src="${ conf.nodexUrl }/jpg/${ fileName }">`
      xb.at('.product-show').append( newDiv)

    })
  })
}
*/



// detect find button click
find_input.addEventListener('keydown', event => {
  if (event.key === 'Enter') {
    findProduct( find_input.value)
  }
})









function showThisProduct( PROD /*PROD_NAME, PIC_FILE*/ ) {

  //make element and show each product in .product-show
  let newDiv = document.createElement('div')
  newDiv.style.display = 'inline-block'
  newDiv.style.overflow = 'hidden'
  
  newDiv.innerHTML = `
    <span 
      style="position: absolute; top: 0; left: 0; background-color: rgba(255,255,255,0.5); font-size: 0.9rem; display: inline-block; padding: 0 0.25em" 
      onclick="seeProductDetail('${ PROD.code + '@' + PROD.sellBy }')">${ PROD.name } (${ PROD.code + '@' + PROD.sellBy })</span>
    <img xzell-prod-pic 
      src="${ conf.nodexUrl }/jpg/${ PROD.pic }" 
      json="${ xb.getBase64FromStr( JSON.stringify( PROD)) }">`

    // ^ embed product info into img element, json attribute

  xb.at('.product-show').append( newDiv)
}




async function findProduct( FIND_VALUE ) {
  //send post body to /xzell/find

  if ( !FIND_VALUE) {
    alert('please put a search word')
    return
  } 

  if (FIND_VALUE.match(/^@[\w-]+/)) {

    //this is the look up for a userName or a shop's userName, so we'll go to /xzell/@:userName
    location.href = conf.nodexUrl + '/xzell/' + FIND_VALUE
  
  } else if (FIND_VALUE.match(/^[^@]+/)) {

    //this is search for productName
    let foundProduct = await nodex.post( conf.nodexUrl + '/xzell/find',
      { name: FIND_VALUE }
    )

    if (foundProduct.done) {

      //clear current product show
      xb.at('.product-show').innerHTML = ''

      //show products
      foundProduct.attach.forEach( prod => {
        showThisProduct( prod /*prod.productName, prod.productPic*/ )
      })

    } else {
      alert('not found product matched your search')
    }

  } else {
    alert('invalid input')
  }

  
}



function seeProductDetail( PROD_CODE ) {
  //call /xzell/product/:productCode
  location.href = conf.nodexUrl + '/xzell/product/' + PROD_CODE
}






//======================= func from old file =====================

function qtyCal( SIGN ) {
  // SIGN: - | +
  if ( SIGN == '+') {
    qty_input.value = Number(qty_input.value) + 1
    total_input.value = Number(qty_input.value) * Number(price_input.value)
    calAll()
  } else {
    if ( qty_input.value > 1) {
      qty_input.value = Number(qty_input.value) - 1
      total_input.value = Number(qty_input.value) * Number(price_input.value)
      calAll()
    }
    
  }
}


function calAll() {
  const taxRate = 0.07
  const price   = getRawNumber( price_input.value)
  const qty     = Number( qty_input.value)
  const total   = price * qty
  const tax     = total * taxRate
  const net     = total + tax
  total_input.value = getTradeValue( total) 
  tax_input.value   = getTradeValue( tax) 
  net_input.value   = getTradeValue( net) 
}



function getTradeValue(value) {
  // Ensure the input is a number
  if (typeof value !== 'number') {
    // You might want to throw an error, return a default, or convert the value
    console.warn("getTradeValue expects a number. Received:", value);
    return String(value); // Return original value as string for non-numeric input
  }

  // Create a NumberFormat instance
  // 'en-US' locale for comma thousands separator and dot decimal
  // minimumFractionDigits and maximumFractionDigits ensure exactly two decimal places
  const formatter = new Intl.NumberFormat('en-US', {
    minimumFractionDigits: 2,
    maximumFractionDigits: 2,
    useGrouping: true // Ensures thousands separators are used
  });

  return formatter.format(value);
}


function getRawNumber(formattedValue) {
  // Ensure the input is a string
  if (typeof formattedValue !== 'string') {
    // If it's already a number, just return it.
    // If it's null/undefined/etc., return null or throw an error.
    if (typeof formattedValue === 'number') {
      return formattedValue;
    }
    console.warn("getRawNumber expects a string or number. Received:", formattedValue);
    return null; // Or throw new TypeError("Input must be a string or number");
  }

  // 1. Remove thousands separators (commas in this case)
  // The g flag ensures ALL commas are replaced, not just the first one.
  const stringWithoutCommas = formattedValue.replace(/,/g, '');

  // 2. Parse the string into a floating-point number
  const rawNumber = parseFloat(stringWithoutCommas);

  // 3. Check if the parsing was successful (i.e., not NaN - Not a Number)
  if (isNaN(rawNumber)) {
    console.warn(`Failed to parse "${formattedValue}" into a number.`);
    return null; // Or return 0, or throw an error
  }

  return rawNumber;
}




function switchToggle( ELEM ) {
  if (ELEM.src.includes('down.svg')) {
    //from off > on
    ELEM.src = '/icon/up.svg'
    search_option_space.hidden = false
    search_icon_wrap.style.backgroundColor = 'var(--grey-200)'
  } else {
    //from on > off
    ELEM.src = '/icon/down.svg'
    search_option_space.hidden = true
    search_icon_wrap.style.backgroundColor = 'white'
  }
}



function showFullPic( PIC_ELEM ) {
  pic_to_show.src = PIC_ELEM.src
  show_full_pic.style.display = 'flex'

  //now fill some data too
  let prodInfo = JSON.parse( 
    xb.getStrFromBase64( PIC_ELEM.getAttribute('json') )
  )

  xzellHome.fullPicProduct = prodInfo

  xb.at([show_full_pic,'[xzell-name]']).textContent = prodInfo.name
  xb.at([show_full_pic,'[xzell-code]']).textContent = prodInfo.code
  xb.at([show_full_pic,'[xzell-by]']).textContent = prodInfo.brand
  xb.at([show_full_pic,'[xzell-price]']).textContent = prodInfo.price
  xb.at([show_full_pic,'[xzell-currency]']).textContent = prodInfo.baseCurrency
  xb.at([show_full_pic,'[xzell-uom]']).textContent = prodInfo.uom


}






//=============================================================

//calAll()

//if click on a pic, show that pic in full width
document.querySelector('.product-show').addEventListener('click', event => {
  if (event.target.tagName.toLowerCase() == 'img') {
    showFullPic( event.target )
  }
})



async function logoutXzell() {

  if (!sessionStorage.userName && !sessionStorage.jwt) {
    alert('You already log-out, or not log-in yet.')
    return
  }

  const reply = await nodex.post( conf.nodexUrl + '/xzell/log-out',
    { userName: sessionStorage.userName },
    { xwt: nodex.getXwt( sessionStorage.userName, sessionStorage.jwt)}
  )

  if (reply.done) {
    //alert('Done. You are now log-out. See you soon.')
    sessionStorage.clear()
    nodex.clearUrlBar()
    location.reload()
  } else {
    alert('Problem: ' + reply.msg)
  }
}


function gotoUrl( URL, OPT='no-xwt' ) {
  //load url and check if there's xwt attach it too
  // goto( conf.nodexUrl + 'xzell/@ssss', true)

  if ( URL ) {
    if (OPT == 'need-xwt') {
      if (sessionStorage.userName) {
        location.href = URL + '?xwt=' + nodex.getXwt( sessionStorage.userName, sessionStorage.jwt)    
      } else {
        alert('please log-in first')
        return
      }
    } else { // OPT = 'no-xwt'
      if (sessionStorage.userName && sessionStorage.jwt) {
        location.href = URL + '?xwt=' + nodex.getXwt( sessionStorage.userName, sessionStorage.jwt)
      } else {
        location.href = URL
      }
    }
  } else {
    //no url, no action
  }
  
}




async function sendOrder() {

  //validate
  if (!sessionStorage.getItem('userName')) {
    alert('please log-in first')
    return
  }

  //all money values are in cent level so the last 2 digits are the cents or สตางค์
  let price     = xzellHome.fullPicProduct.price
  let qty       = Number( full_pic_qty.value)
  let totalPrice = price * qty
  let taxRate   = 0.07
  let totalTax  = Math.round(totalPrice * taxRate)
  let netPrice  = totalPrice + totalTax

  let serverReply = await nodex.post( conf.nodexUrl + '/xzell/order',
    {
      productName     : xzellHome.fullPicProduct.name,
      productCodeFull : xzellHome.fullPicProduct.code + '@' + xzellHome.fullPicProduct.sellBy,
      price           : price,
      qty             : qty,
      totalPrice      : totalPrice,
      taxCode         : xzellHome.fullPicProduct.tax,
      taxRate         : taxRate,
      totalTax        : totalTax,
      netPrice        : netPrice,
      currency        : xzellHome.fullPicProduct.baseCurrency,
      uom             : xzellHome.fullPicProduct.uom,
      productPic      : xzellHome.fullPicProduct.pic,
      customer        : sessionStorage.getItem('userName')
    }
  )

  if (serverReply.done) {
    alert('your order is sent, orderNum = ' + serverReply.attach.orderNum)
  } else {
    alert('ERROR: ' + serverReply.msg)
  }
}






</script>
</body>
</html>