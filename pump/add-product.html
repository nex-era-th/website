<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Add Product</title>
  <script src="conf.js"></script>
  <script src="pump-b.js"></script>
  <script src="/js/xdev-b.js"></script>
  <link href="/js/w3.css" rel="stylesheet" type="text/css">
  <link href="/js/material-x.css" rel="stylesheet" type="text/css">
  <link href="pump.css" rel="stylesheet" type="text/css">
<style>
  /*
  *,
  *::before,
  *::after { box-sizing: border-box; }
  html { font-size: 16px; }
  small { font-size: 0.8rem }
  label { font-size: 1.0rem }
  .medium { font-size: 1.0rem }
  .default { font-size: 1.25rem }
  .large { font-size: 1.5rem }
  .xlarge { font-size: 2.0rem }

  .world-space { max-width: 800px; margin: auto; }
  

  .my-form > input {
    width: 100%; padding: 4px;
  }
  .my-form input,
  .my-form textarea,
  .my-form select,
  .my-form option {
    font-size: 1.25rem;
  }

  .line-in-form {
   grid-column: span 2; width: 100%; border-top: 1px solid gray; margin: 16px 0;
  }

  .hover-it:hover { background-color: #b2ebf2;}
  */
</style>
</head>
<body>


<div class="world-space">
  

  <!-- title / page name -->
  <div style="margin-bottom: 24px;">
    <div style="color: blue; background-color: white; z-index: 50; font-size: 1.5rem; font-style: bold">Add Product*</div>
    <p class="small">เพิ่มสินค้า คำว่าสินค้านี้จะเป็นของที่ซื้อมาใช้ในบริษัทก็ได้ ซื้อมาเพื่อขายก็ได้ และอาจไม่ใช่ของสำหรับร้านกาแฟ หรือปั๊มน้ำมันก็ได้ คือนอกระบบทั้ง 2 หรือจะเป็นทรัพย์สินของบริษัทก็ได้ (asset)</p>
  </div>


  <!-- top action -->
  <div id="topActBox" style="display: none; align-items: center; justify-content: space-around; margin-bottom: 24px;">
    <button class="w3-button" style="padding: 4px 8px; background-color: #fdd835;" 
    onclick="">Edit</button>
    <button class="w3-button" style="padding: 4px 8px; background-color: #757575;" disabled>Delete</button>
  </div>


  <!-- form / grid -->
  <div class="my-form" id="addProductForm" style="display: grid; grid-template-columns: 30% 70%; align-items: center; gap: 4px">

    <label>ภาพ</label>
    <div>
      <div style="cursor: pointer;" onclick="this.children[0].click()">
        <input type="file" id="picFile" hidden 
          onchange="xb.readPicFileAsDataUrl( this).then( durl => showPicHere.src = durl); picBox.hidden = false;">
        <div class="hover-it" style="display: inline-block; padding-right: 8px;">
          <img src="/icon-x/Image.svg" width="32">
          <small style="color: #5c6bc0">เลือกรูป</small>
        </div>
      </div>
      <div id="picBox" style="position: relative" hidden>
        <img id="showPicHere" style="width: 100%; object-fit: cover;">
        <img src="/icon-x/X.svg" style="width: 32px; position: absolute; left: 0; bottom: 0; cursor: pointer"
        onclick="clearPic()">
      </div>
    </div>


    <label>Code*</label>
    <input type="text" id="code" placeholder="รหัสสินค้าที่เราตั้ง">
    <label>ชื่อสินค้า*</label>
    <input type="text" id="name" placeholder="">  
    <label>Description*</label>
    <textarea id="description" rows="3" placeholder=""></textarea>
    <label>Brand</label>
    <input id="brand" type="text">
    <label>Bar Code</label>
    <input id="barCode" type="text">
    <label>Partner Code</label>
    <input id="partnerCode" type="text" placeholder="code ของ partner">
    <label>Other Code</label>
    <input id="otherCode" type="text" placeholder="code อื่นๆ ถ้ามี">


    <hr class="line-in-form">
      
    <label>หมวดหมู่*</label>    
    <select id="category" class="w3-select">
      <option>-----</option>
      <option>เครื่องดื่ม</option>
      <option>อาหาร</option>
      <option>เสื้อผ้า</option>
      <option>บริการ</option>
      <option>อื่นๆ</option>
    </select>

    

    <label>หน่วยนับ*</label>
    <input type="text" id="uom" placeholder="เช่น ชิ้น อัน กก. ลิตร">
    <label>ราคา/หน่วย*</label>
    <input type="number" id="unitPrice">

    <label>สกุลเงิน</label>
    <select id="currency" class="w3-select" disabled>
      <option>บาท</option>
      <option>USD</option>
    </select>

    <label>Minimum Order</label>
    <input type="number" id="minOrder" value="1" placeholder="จำนวนขั้นต่ำที่ขาย">
    
    
    <label>ต้อง stock?</label>
    <div><input id="mustStock" type="checkbox" class="w3-check"></div>    
    <label>Minimum Stock</label>
    <input type="number" id="minStock" placeholder="ขั้นต่ำที่ต้องสั่งเพิ่ม">


    <hr class="line-in-form">


    <small>รับประกันกี่ปี</small>
    <select id="warranty" class="w3-select">
      <option>-----</option>
      <option>1 ปี</option>
      <option>2 ปี</option>
    </select>

    <small>คืนได้ภายใน</small>
    <select id="returnBy" class="w3-select">
      <option>-----</option>
      <option>7 วันนับจากวันซื้อ/รับของ</option>
      <option>1 เดือนนับจากวันซื้อ/รับของ</option>
    </select>





    <hr class="line-in-form"><!---------- supplier ------------>

    <small style="grid-column: span 2;">กรณีสินค้านี้ต้องสั่งซื้อจาก Supplier/Partner ให้กำหนด Partner ในนี้ หาก Partner นี้ยังไม่มีใน software ให้เพิ่มใหม่</small>
    <label>Supplier</label>
    <div style="display: grid; grid-template-columns: 80% 20%; align-items: center;">
      <input id="findSupplierInput" type="search" class="w3-input w3-border" placeholder="ค้นชื่อ">
      <div style="display: flex; align-items: center; justify-content: center; cursor: pointer; "
      onclick="findSupplier()"><img src="/icon-x/Search.svg" width="24"></div>
    </div>
    <div></div>
    <!-- show partner name here -->
    <div id="supplier" supplier-id style="margin-top: 8px; text-decoration: underline;" class="default"></div>

    <!-- action -->
    <div style="grid-column: span 2; display: flex; justify-content: space-around; margin-top: 24px">
      <div style="cursor: pointer;" 
      onclick="location.href = 'add-partner.html';">
        <img src="/icon-x/Plus.svg" style="width: 24px; border-radius: 50%; background-color: #9fa8da;">
        <small style="font-size: 0.8rem; color: #9fa8da">เพิ่ม Partner ใหม่</small>
      </div>
      <div onclick="clearSupplier()" style="cursor: pointer;">
        <img src="/icon-x/Minus.svg" style="width: 24px; border-radius: 50%; background-color: #ef9a9a;"> 
        <small style="font-size: 0.8rem; color: #9fa8da">Clear</small>
      </div>
    </div>
    
    <hr class="line-in-form"><!------------------------------------>

    <label>Status</label>
    <select class="w3-select" id="status"> 
      <option>-----</option>
      <option>ขายได้ / Available</option>
      <option>หยุดขายชั่วคราว / Pause</option>
      <option>เลิกขาย / Not Available</option>
    </select>

    <label>เริ่มขายตั้งแต่</label>
    <input type="date" id="start" class="w3-input">

    <hr class="line-in-form"><!------------------------------------>

    <label>Note</label>
    <textarea id="note" rows="4" placeholder=""></textarea>
    
    <label>userName*</label>
    <input id="userName" type="text" autocomplete="off">

  </div>



  <!-- form action -->
  <div style="display: flex; align-items: center; justify-content: space-around; margin-top: 40px; margin-bottom: 60px;">
    <button class="w3-button w3-blue" 
    onclick="addProduct()">Save</button>
    <button class="w3-button w3-light-grey" 
    onclick="location.reload()">Cancel / Clear</button>
  </div>



</div>



<!-- page action -->
<div style="padding: 4px; position: fixed; left: 0; bottom: 0; ">
  <img src="/icon/u-turn.svg" style="cursor: pointer; width: 32px;" 
  onclick="history.back()">
</div>


<script>
///////////////////////////////////////////////////////////////////


// this code scroll page to top after reload
window.onload = () => {
  setTimeout( () => {
    window.scrollTo(0,0)
  }, 10)
}



// DEFINITION

const domain = PUMP_DOMAIN //'http://192.168.1.111:4000';
const showPicHere = document.getElementById('showPicHere');
const picBox = document.querySelector('#picBox')

//const lastEdit = new Date
//document.getElementById('lastEdit').value = lastEdit




/*
async function fetchThis( data, api ) {
    
  let response = await fetch( domain + api, {
    method  : 'POST',
    headers : {'Content-Type':'application/json'},
    body    : JSON.stringify( data )

  })
  
  return response.json()

}
*/

async function addProduct() {
  /*
      send data to /add-product
      get { done: true|false, msg: ... ,data: [_id] }
  */

  let data = {
    
    pic: document.querySelector('#showPicHere').src,
    code: document.querySelector('#code').value,
    name: document.querySelector('#name').value,
    description: document.querySelector('#description').value,
    brand: document.querySelector('#brand').value,
    
    barCode: document.querySelector('#barCode').value,
    partnerCode: document.querySelector('#partnerCode').value,
    otherCode: document.querySelector('#otherCode').value,
    
    category: document.querySelector('#category').value,
    uom: document.querySelector('#uom').value,
    unitPrice: document.querySelector('#unitPrice').value,
    currency: document.querySelector('#currency').value,
    
    minOrder: document.querySelector('#minOrder').value,
    mustStock: document.querySelector('#mustStock').checked,
    minStock: document.querySelector('#minStock').value,
    warranty: document.querySelector('#warranty').value,
    returnBy: document.querySelector('#returnBy').value,

    supplierId: document.querySelector('#supplier').getAttribute('supplier-id'),
    partnerName: document.querySelector('#supplier').textContent,
    
    status: document.querySelector('#status').value,
    start: document.querySelector('#start').value,
    note: document.querySelector('#note').value,
    userName: document.querySelector('#userName').value
  }

  if (!data.code || !data.name || !data.description || !data.category || !data.uom || !data.unitPrice || !data.userName ) {
    alert('โปรดป้อนข้อมูลทุกช่องที่มีเครื่องหมาย * ขอบคุณค่ะ')
    return
  }

  if (!pumpb.youAreTestUser(data.userName)) {
    alert('พี่ไม่ใช่ user ที่ถูกต้องค่ะ ข้อมูลนี้ต้องป้อนโดย user ที่ถูกต้องเท่านั้นนะ อย่ามาแอบป้อนนะ')
    return
  }

  data.masterKey = MASTER_KEY


  // pass - basic validation


  try {

    let reply = await pumpb.fetchThis( data, '/add-product')
    
    if (reply.done) {
      alert(`เรียบร้อยค่า แจ่มเลย`)
      location.reload()
    } else {
      alert(`Save ข้อมูลไม่ได้อ่ะ \n` + reply.msg)
    }

  } catch(er) {
    alert('มีปัญหาทางเทคนิคค่ะ ลองอีกทีมั๊ย')
  }
  
}



async function findSupplier() {
  // find and show it on #supplier

  let inputEl = document.querySelector('#findSupplierInput')

  if (!inputEl.value) {
    alert('รบกวนใส่ชื่อ Supplier ด้วยค่ะ')
    return
  }

  try {

    let reply = await pumpb.fetchThis(null, '/find-partner?name=' + inputEl.value, 'get')

    if (reply.done) {

      let supEl = document.querySelector('#supplier')
      supEl.textContent = `${reply.data.name}`
      supEl.setAttribute('supplier-id', reply.data._id)

    } else {
      alert('ไม่พบข้อมูลค่ะ โปรดลองชื่ออื่นดูอีกครั้ง')
      document.querySelector('#findSupplierInput').value = ''
      document.querySelector('#findSupplierInput').focus()
    }

  } catch(er) {
    alert('มีปัญหาทางเทคนิคค่ะ')
  }

}


function clearSupplier() {
  // clear supplier selection from search box
  document.querySelector('#findSupplierInput').value = ''
  document.querySelector('#supplier').textContent = ''
  document.querySelector('#supplier').setAttribute('supplier-id','')
}


function clearPic() {
  // hide #picBox and clear #showPicHere.src
  picBox.hidden = true
  showPicHere.removeAttribute('src')
}



</script>
</body>
</html>