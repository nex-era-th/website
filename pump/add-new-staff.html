<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Add Staff</title>
  <script src="conf.js"></script>
  <script src="pump-b.js"></script>
  <script src="/js/xdev-b.js"></script>
  <link href="/js/w3.css" rel="stylesheet" type="text/css">
  <link href="/js/material-x.css" rel="stylesheet" type="text/css">

<style>
  *,
  *::before,
  *::after { box-sizing: border-box; }
  html { font-size: 16px; }
  .world-space { max-width: 800px; margin: auto; }
  .my-form > input {
    width: 100%; padding: 4px;
  }
  .my-form > * {
    font-size: 1.25rem;
  }

  .line-in-form {
   grid-column: span 2; width: 100%; border-top: 1px solid gray; margin: 16px 0;
  }

  .hover-it:hover { background-color: #b2ebf2;}

</style>
</head>
<body>

<h3 id="screenName" style="padding: 16px; color: blue; background-color: white; z-index: 50">ป้อนข้อมูลพนักงาน</h3>

<!-- top action -->
<div id="topActBox" style="display: none; align-items: center; justify-content: space-around; margin-bottom: 24px;">
  <button class="w3-button" style="padding: 4px 8px; background-color: #fdd835;" 
  onclick="editStaff()">Edit</button>
  <button class="w3-button" style="padding: 4px 8px; background-color: #757575;" disabled>Delete</button>
</div>


<div class="world-space" style="padding: 0 16px; margin-bottom: 60px;">
  

  <div class="my-form" id="add_new_staff_form" style="display: grid; grid-template-columns: 30% 70%; align-items: center; gap: 4px">

    <label>รูปถ่ายใบหน้า</label>
    <div>
      <div id="choosePicInputBox" style="cursor: pointer;" onclick="this.children[0].click()">
        <input type="file" id="facePicFile" hidden 
          onchange="xb.readPicFileAsDataUrl( this).then( durl => showFacePicHere.src = durl); showFacePicHere.hidden = false;">
        <div class="hover-it" style="display: inline-block; padding-right: 8px;">
          <img src="/icon-x/Image.svg" width="32">
          <small style="color: #5c6bc0">เลือกรูป</small>
        </div>
      </div>
      <img id="showFacePicHere" hidden
      style="width: 100%; object-fit: cover;">
    </div>


    <label>ชื่อเล่น*</label>
    <input type="text" id="nickName">
    <label>ชื่อจริง*</label>
    <input type="text" id="firstName">  
    <label>นามสกุล*</label>
    <input type="text" id="lastName">  
    <label>ตำแหน่ง</label>
    <input type="text" id="position">  

    <label>แผนก</label>
    <!--input type="text" id="department"-->
    <select id="department" class="w3-select">
      <option>-----</option>
      <option>ทีมเติมน้ำมัน</option>
      <option>ร้านกาแฟอเมซอนคาเฟ่</option>
      <option>ทั่วไป</option>
      <option>บริหาร</option>
      <option>อื่นๆ</option>
    </select>  


    <label>หน้าที่</label>
    <textarea rows="4" id="role" placeholder="ให้ทำงานอะไรบ้าง"></textarea>  

    <label>รหัสพนักงาน</label>
    <input type="text" id="staffCode">
    <label>เริ่มทำงาน</label>
    <input type="date" id="start">  
    <label>โทร*</label>
    <input type="number" id="tel">
    <label>LINE Id</label>
    <input type="text" id="lineId">
    <label>FB Messgr</label>
    <input type="text" id="facebookMessenger">
    <label>ที่อยู่*</label>
    <textarea id="address" rows="4"></textarea>


    <!---------------------------------------------------------->
    <hr class="line-in-form">

    <label>สัญชาติ</label>
    <select id="nationality" class="w3-select">
      <option>ไทย</option>
      <option>พม่า</option>
      <option>เขมร</option>
      <option>ลาว</option>
      <option>ฝรั่ง</option>
      <option>อื่นๆ</option>
    </select>

    <label>บัตรประชาชน</label>
    <input type="text" id="citizenId" placeholder="หรือ passport ฯลฯ">

    <label>เพศ</label>
    <select id="sex" class="w3-select">
      <option value="ชาย">ชาย</option>
      <option value="หญิง">หญิง</option>
      <option value="อื่นๆ">อื่นๆ</option>
    </select>


    <label>อายุ</label>
    <input type="number" id="age">
    <label>วันเกิด</label>
    <input type="date" id="birthDate">


    <hr class="line-in-form">

    <label>ความเชี่ยวชาญ</label>
    <div>
      <input name="skill" id="filling fuel" type="checkbox" value="เติมน้ำมัน" class="w3-check"> เติมน้ำมัน<br>
      <input name="skill" id="cashier" type="checkbox" value="คิดเงิน" class="w3-check"> คิดเงิน<br> 
      <input name="skill" id="inspectFuel" type="checkbox" value="วัดคุณภาพน้ำมัน" class="w3-check"> วัดคุณภาพน้ำมัน<br>
      <input name="skill" id="captain" type="checkbox" value="กัปตัน/คุมทีมเติมน้ำมัน" class="w3-check"> กัปตัน/คุมทีมเติมน้ำมัน<br>
      <input name="skill" id="backOfficeSoftware" type="checkbox" value="Back Office Software" class="w3-check"> Back Office Software<br>
    </div>

    <hr class="line-in-form">


    <label>ที่ทำงาน</label>
    <input type="text" id="workPlace" value="นวประชา 2025">


    <hr class="line-in-form">
    <!---------------------------------------------------------->


    <label>ค่าจ้าง</label>
    <input type="number" id="wages">

    <label>ประเภทจ้าง</label>
    <select id="hiringType" class="w3-select">
      <option>-----</option>
      <option>รายเดือน</option>
      <option>รายวัน</option>
      <option>มีสัญญาเป็นระยะเวลา</option>
      <option>ตามตกลงเป็นครั้งๆ</option>
      <option>อื่นๆ</option>
    </select>

    <hr class="line-in-form">

    <label>สวัสดิการ</label>
    <div>
      <input name="benefit" id="uniform" type="checkbox" value="ชุดทำงาน" class="w3-check"> ชุดทำงาน<br>
      <input name="benefit" id="socialSecurity" type="checkbox" value="ประกันสังคม" class="w3-check"> ประกันสังคม<br>
      <input name="benefit" id="food" type="checkbox" value="อาหาร" class="w3-check"> อาหาร<br> 
      <input name="benefit" id="transportation" type="checkbox" value="ค่าพาหนะ" class="w3-check"> ค่าพาหนะ<br>
      <input name="benefit" id="healthcare" type="checkbox" value="ประกันสุขภาพ" class="w3-check"> ประกันสุขภาพ<br>
      <input name="benefit" id="otherBenefit" type="checkbox" value="อื่นๆ" class="w3-check"> อื่นๆ<br>
    </div>




    <!---------------------------------------------------------->
    <hr class="line-in-form">

    <label>สถานะ</label>
    <select id="status" class="w3-select">
      <option value="ยังไม่เป็นพนักงาน">ยังไม่เป็นพนักงาน</option>
      <option value="เป็นพนักงานแล้ว">เป็นพนักงานแล้ว</option>
      <option value="พักงานชั่วคราว">พักงานชั่วคราว</option>
      <option value="ไม่ได้เป็นพนักงานแล้ว">ไม่ได้เป็นพนักงานแล้ว</option>
    </select>

    <!---------------------------------------------------------->
    <hr class="line-in-form">

    <label>Ref</label>
    <input type="text" id="ref" placeholder="อ้างอิงเอกสาร">

    <label>บันทึก</label>
    <textarea id="note" rows="8" placeholder="เช่น เป็นคนเก่า / มีประสบการณ์ตรงกี่ปี ..."></textarea>
    
    <label>ป้อนข้อมูลโดย*</label>
    <input id="enterBy" type="text" placeholder="เช่น @sern, @john ...">

    <!--label>วันแก้ไขหลังสุด</label>
    <textarea id="lastEdit" disabled></textarea-->

  </div>



  <!-- form action -->
  <div id="pageActBox" style="display: flex; align-items: center; justify-content: space-around; margin-top: 40px; margin-bottom: 60px;">
    <button id="saveButton" class="w3-button w3-blue" 
    onclick="sendData()">Save</button>
    <button id="clearButton" class="w3-button w3-light-grey" 
    onclick="location.reload()">Cancel / Clear</button>
  </div>



</div>


<!-- u turn -->
<div style="padding: 4px; position: fixed; left: 0; bottom: 0; ">
  <img src="/icon/u-turn.svg" style="width: 32px; height: 32px; cursor: pointer;" 
  onclick="location.href='/pump/index.html';">
</div>


<script>
///////////////////////////////////////////////////////////////////



// this code scroll page to top after reload
window.onload = () => {

  // scroll to top at first
  setTimeout( () => {
    window.scrollTo(0,0)
  }, 10)


  // check mode: view|edit
  const urlParams = new URLSearchParams(window.location.search)
  const staffId = urlParams.get('staffId')
  const mode = urlParams.get('mode')

  if (mode == 'view' && staffId) {
    //alert('this is view mode for id=' + staffId)

    try {

      pumpb.fetchThis( null, '/find-staff?id=' + staffId, 'get').then( reply => {

        if (reply.done) {
          
          let data = reply.data
          document.querySelector('#screenName').textContent = 'ข้อมูลพนักงาน'
          document.querySelector('#topActBox').style.display = 'flex'

          // disable all fields, hide Actions
          document.querySelector('#choosePicInputBox').hidden = true
          document.querySelectorAll('input').forEach( el => {
            el.disabled = true
          })
          document.querySelectorAll('textarea').forEach( el => {
            el.disabled = true
          })
          document.querySelectorAll('select').forEach( el => {
            el.disabled = true
          })
          document.querySelector('#pageActBox').style.display = 'none'


          // fill all general fields
          for (key in data) {
            let elem = document.querySelector(`#${key}`)
            if (elem) {
              elem.value = data[key] 
            }
          }

          if (data.skills.length) {
            document.querySelectorAll('[name="skill"]').forEach( el => {
              if (data.skills.includes(el.value)) {
                el.checked = true
              }
            })
          } 

          if (data.benefits.length) {
            document.querySelectorAll('[name="benefit"]').forEach( el => {
              if (data.benefits.includes(el.value)) {
                el.checked = true
              }
            })
          }

          if (data.facePic) {
            document.querySelector('#showFacePicHere').src = data.facePic
          }




        } else {
          alert('ไม่พบข้อมูลค่ะ โปรดลองอีกครั้ง')
        }

      })

      

    } catch(er) {
      alert('error = ' + er.message)
    }







  }

}





// DEFINITION

const domain = PUMP_DOMAIN //'http://192.168.1.111:4000';
const showFacePicHere = document.getElementById('showFacePicHere');


//const lastEdit = new Date
//document.getElementById('lastEdit').value = lastEdit





async function fetchThis( data, api ) {
    
  let response = await fetch( domain + api, {
    method  : 'POST',
    headers : {'Content-Type':'application/json'},
    body    : JSON.stringify( data )

  })
  
  return response.json()

}


async function sendData() {
  try {
    let data = {
      facePic: showFacePicHere.src,
      nickName: document.getElementById('nickName').value,
      firstName: document.getElementById('firstName').value,
      lastName: document.getElementById('lastName').value,
      position: document.getElementById('position').value,
      department: document.getElementById('department').value,
      role: document.getElementById('role').value,
      staffCode: document.getElementById('staffCode').value,
      start: document.getElementById('start').value,
      tel: document.getElementById('tel').value,  
      lineId: document.getElementById('lineId').value,
      facebookMessenger: document.getElementById('facebookMessenger').value,
      address: document.getElementById('address').value,

      nationality: document.getElementById('nationality').value,
      citizenId: document.getElementById('citizenId').value,
      sex: document.getElementById('sex').value,
      age: document.getElementById('age').value,
      birthDate: document.getElementById('birthDate').value,


      skills: Array.from( document.querySelectorAll('input[name="skill"]:checked') ).map( el => el.value ),

      workPlace: document.getElementById('workPlace').value,

      wages: document.getElementById('wages').value,
      hiringType: document.getElementById('hiringType').value,

      benefits: Array.from( document.querySelectorAll('input[name="benefit"]:checked') ).map( el => el.value ),

      status: document.getElementById('status').value,
      ref: document.getElementById('ref').value,
      note: document.getElementById('note').value,
      enterBy: document.getElementById('enterBy').value,
      time: Date.now()
    }


    // validate
    if( !data.nickName || !data.firstName || !data.lastName || !data.tel || !data.enterBy || !data.address ) {
      alert('กรุณากรอกข้อมูลให้ครบถ้วนในช่องที่มีเครื่องหมาย *')
      return
    }


    // pass - basic validation


    let resp = await fetchThis( data, '/add-staff' )
    //alert( JSON.stringify( resp ) )

    if (resp.done) {
      alert(`เรียบร้อย -- Add Staff ชื่อ ${data.firstName} ${data.lastName} เรียบร้อยแล้ว`)
      location.reload()
      //document.getElementById('nickName').focus()
    } else {
      alert('ไม่สามารถ Save ข้อมูลนี้ได้ โปรดลองอีกครั้ง')
    }
    

  
  } catch( error ) {
    console.error( error )
    alert('มีปัญหาทางเทคนิค ลองดูอีกครั้ง หากยังมีปัญหา โปรดติดต่อ @admin')
  }
}




function editStaff() {
  // change from view mode to edit mode

  // preparing the page
  document.querySelector('#screenName').textContent = 'แก้ไขข้อมูลพนักงาน'
  document.querySelector('#topActBox').style.display = 'none'
  document.querySelector('#choosePicInputBox').hidden = false
  document.querySelectorAll('input').forEach( el => {
    el.disabled = false;
  })
  document.querySelectorAll('select').forEach( el => {
    el.disabled = false;
  })
  document.querySelectorAll('textarea').forEach( el => {
    el.disabled = false;
  })
  document.querySelector('#pageActBox').style.display = 'flex'

  // clear browser query
  window.history.replaceState( null,'', window.location.origin + window.location.pathname)

}





</script>
</body>
</html>