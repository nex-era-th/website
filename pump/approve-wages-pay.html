<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Approve Wages Pay</title>
<script src="conf.js"></script>
<script src="pump-b.js"></script>
<script src="/js/xdev-b.js"></script>
<link href="/js/w3.css" rel="stylesheet" type="text/css">
<link href="/js/material-x.css" rel="stylesheet" type="text/css">
<link href="pump.css" rel="stylesheet" type="text/css">
<style>
  /* put local styles here * /
  .grid-table { display: grid; gap: 1px; }
  .grid-table span { 
    background-color: #eeeeee; font-size: 0.8rem; padding: 4px; 
    height: 100%;  
  } */
  .grid-space > * { padding: 16px 8px }
</style>
</head>
<body>

<div class="world-space">

  <!-- title / page name -->
  <div style="margin-bottom: 24px;">
    <div id="pageTitle" style="color: blue; background-color: white; z-index: 50; font-size: 1.5rem; font-style: bold">Approve Wages Pay*</div>
    <p id="pageBrief" class="small">เมื่ออนุมัติในนี้แล้ว ถือว่า ยอดเงินทั้งหมดในนี้ ถูกต้อง และบริษัทจะจ่ายเงินให้พนักงานตามยอดเหล่านี้ โปรแกรมจะสร้าง Wages Payment Guide แสดงยอดสุทธิ ที่จะต้องจ่ายให้กับแต่ละคน เพื่อสะดวกในการจ่ายเงิน</p>
  </div>


  <!-- find -- >
  <div style="display: grid; grid-template-columns: 80% 20%; align-items: center;">
    <input type="text" style="width: 100%; border-radius: 10px 0 0 10px; font-size: 1.2rem;" class="w3-input w3-border" placeholder="ค้นชื่อสินค้า ...">
    <button class="w3-button w3-blue" 
    style="border-radius: 0 10px 10px 0; padding: 11px 0"><img src="/icon-x/Search.svg" width="24"></button>
  </div-->


  <!-- top action -->
  <div id="topActBox" style="display: none; align-items: center; justify-content: space-around; margin-bottom: 24px;">
    <button class="w3-button" style="padding: 4px 8px; background-color: #fdd835;" 
    onclick="editPartner()">Edit</button>
    <button class="w3-button" style="padding: 4px 8px; background-color: #757575;" disabled>Delete</button>
  </div>



  <!-- form --><!--==========================================================================-->


  <div class="form-space" style="display: grid; grid-template-columns: 30% 70%; align-items: center; gap: 4px; margin-top: 32px">

    <!-- เดือน -->
    <label class="indigo">เดือน*</label>
    <input id="payMonth" type="month" class="w3-input" onchange="getPayMonthInfo()">
    <div id="monthInfo" style="grid-column: span 2; padding: 16px; grid-template-columns: auto auto;" class="grid-space"></div>

    <!-- พนักงาน -->
    <label class="indigo">พนักงาน*</label>
    <select id="chooseStaff" class="w3-select" onchange="getStaffInfo()">
      <option>-----</option>
      <!--option>john</option>
      <option>may</option>
      <option>voon</option>
      <option value="6941a431a98a2683a2d047f0">test</option-->
    </select>

    <div id="staffInfo" class="grid-space" style="grid-column: span 2; padding: 16px; grid-template-columns: auto auto;">
    </div>

    
    <hr class="line-in-form"><!---------------------------------------------------------------->

    <!-- ค่าทำงานล่วงเวลา และทำงานวันหยุด -->
    <label id="otBoxLabel" style="grid-column: span 2;" class="indigo">ค่า OT, ค่าทำงานวันหยุด</label>
    <div id="otBoxGrid" class="grid-space" style="grid-column: span 2; padding: 16px; grid-template-columns: auto auto auto auto auto auto;">

      <span>วันที่</span><span>รายการ</span><span>เริ่ม</span><span>หยุด</span><span>รวมเวลา</span><span class="tr">คิดเป็นเงิน</span>
      
      <!--
      <span>02/12</span><span>ค่าล่วงเวลาวันทำงาน</span><span>14:00</span><span>18:00</span><span>04:00</span><span class="tr">300.00</span>
      <span>05/12</span><span>ค่าทำงานวันหยุด</span><span>05:00</span><span>13:00</span><span>08:00</span><span class="tr">400.00</span>
      <span>05/12</span><span>ค่าล่วงเวลาวันหยุด</span><span>14:00</span><span>18:00</span><span>04:00</span><span class="tr">600.00</span>
      <span style="grid-column: span 5; text-align: center;">รวม</span><span class="tr">1,300.00</span>
      -->

    </div>
   


    <hr class="line-in-form"><!---------------------------------------------------------------->



    <!-- เงินเพิ่มอื่นๆ -->
    <label id="otherAddLabel" style="grid-column: span 2;" class="indigo">เงินเพิ่มอื่นๆ</label>
    <div id="otherAddGrid" class="grid-space" style="grid-column: span 2; padding: 16px; grid-template-columns: auto auto auto">

      <span>ลำดับ</span><span>รายการ</span><span class="tr">ยอดเพิ่ม</span>

    </div>





    <hr class="line-in-form"><!---------------------------------------------------------------->

    <!-- เงินหัก -->
    <label id="deductGridLabel" style="grid-column: span 2;" class="indigo">เงินหัก</label>
    <div id="deductGrid" class="grid-space" style="grid-column: span 2; padding: 16px; grid-template-columns: auto auto auto;">

      <!--span>วันที่</span><span>รายการ</span><span>เริ่ม</span><span>หยุด</span><span>รวมเวลา</span><span class="tr">คิดเป็นเงิน</span-->


      <!--span>01/12</span><span>ยังไม่เปิดกิจการ</span><span>--</span><span>--</span><span>--</span><span class="tr">-400.00</span>
      <span>30/12</span><span>ประกันสังคม 5% ของเงินเดือน</span><span>--</span><span>--</span><span>--</span><span class="tr">-600.00</span>
      <span style="grid-column: span 5;" class="tc">รวม</span><span class="tr">-1,000.00</span-->

      <span>ลำดับ</span><span>รายการ</span><span class="tr">ยอดหัก</span>


    </div>


    <hr class="line-in-form"><!---------------------------------------------------------------->
    
    <!-- สรุปยอดรายได้ -->
    <label style="grid-column: span 2;" class="indigo">สรุปยอดรายได้</label>
    <div id="incomeSumGrid" style="grid-column: span 2; grid-template-columns: auto auto; padding: 16px" class="grid-space">
      <span>เงินเดือน หรือเงินได้รายวันทั้งเดือน</span>
      <span id="normalWagesSum" class="tr"></span>
      <span>ค่า OT, ค่าทำงานวันหยุด</span>
      <span id="otSum" class="tr"></span>
      <span>เงินเพิ่มอื่นๆ</span>
      <span id="otherAddSum" class="tr"></span>
      <span>เงินหัก</span>
      <span id="deductWagesSum" class="tr"></span>
      <span>เงินได้สุทธิ</span>
      <span id="netWagesSum" class="tr"></span>
    </div>


    <hr class="line-in-form"><!---------------------------------------------------------------->

    <!-- ภงด -->
    <label style="grid-column: span 2;" class="indigo">การหัก ณ ที่จ่าย ภาษีเงินได้บุคคลธรรมดา (ภงด.)</label>
    <div class="grid-space" style="grid-column: span 2; grid-template-columns: auto auto; padding: 16px">

      <span>ประเมินรายได้ทั้งปี (รายได้ปกติตลอดปี + เงินเพิ่ม 5%)</span>
      <span id="estimateAnnualIncome" class="tr"></span><!--151,200.00-->
      <span>หักค่าใช้จ่ายส่วนตัว 50%</span>
      <span id="personalExpense" class="tr"></span><!---75,600.00-->
      <span>หักค่าลดหย่อนส่วนตน</span>
      <span id="personalAllowance" class="tr"></span><!-- -60,000.00 -->
      <span>หักประกันสังคม</span>
      <span id="socialSecFundDeduct" class="tr"></span><!-- -7,200.00 -->
      <span>เงินได้สุทธิ เพื่อคำนวน ภงด.</span>
      <span id="netToCalcIncomeTax" class="tr"></span><!--8,400.00-->
      <span>การหักภาษีเงินได้บุคคลธรรมดา</span>
      <span id="deductForPersonalIncomeTax" class="tr"></span><!--0.00-->

    </div>

    <div style="grid-column: span 2; margin-left: 16px; color: red" class="small"><u>หมายเหตุ</u> กรณีคำนวนแล้ว รายได้สุทธิ เพื่อคำนวนภาษีเงินได้บุคคลธรรมดา ไม่เกิน 150,000.00 บาท ท่านจะได้รับการยกเว้น ไม่ต้องถูกหักภาษีนี้</div>

    <hr class="line-in-form"><!---------------------------------------------------------------->

    <!-- สรุป -->
    <label style="grid-column: span 2;" class="indigo">สรุป</label>
    <div class="grid-space" style="grid-column: span 2; grid-template-columns: auto auto; padding: 16px">
      <span>รายได้สุทธิ</span>
      <span id="netWagesPay" class="tr"></span>
    </div>


    <hr class="line-in-form"><!---------------------------------------------------------------->

    <label bottom-of-form>Note</label>
    <textarea id="note" rows="2" bottom-of-form></textarea>
    <label bottom-of-form>อนุมัติโดย*</label>
    <input id="approvedBy" type="text" autocomplete="off" class="w3-input" bottom-of-form placeholder="ต้องอนุมัติโดย ผู้อนุมัติการจ่ายเงิน เท่านั้น">

  </div>



  <!-- form action -->
  <div style="display: flex; align-items: center; justify-content: space-around; margin-top: 32px">
    <button id="approveButton" class="w3-button w3-green" onclick="approveWagesPay()">Approve</button>
    <button id="convertButton" class="w3-button w3-blue" onclick="makePayslip()" disabled>Convert to Payslip</button>
    <button id="clearButton" class="w3-button w3-yellow" onclick="pumpb.clearBrowserBar(); location.reload()">Clear</button>
  </div>


  <div id="footer" class="small" hidden>บจ. นวประชา 2025<br>
    994/3 ถนนเพชรเกษม ตำบลห้วยจรเข้ อำเภอเมืองนครปฐม จังหวัดนครปฐม 73000<br>
    หมายเลขประจำตัวผู้เสียภาษี 0735567011184
  </div>



</div>



<!-- page action -->
<div style="padding: 4px; position: fixed; left: 0; bottom: 0; ">
  <img src="/icon/u-turn.svg" style="width: 32px; height: 32px; cursor: pointer;" 
  onclick="history.back()">
</div>


<script>
//////////////////////////////////////////////////////////////////

let MODE = 'new';
const PGOJ = {};

// this code scroll page to top after reload
window.onload = async () => {

  // scroll to top on reload
  setTimeout( () => {
    window.scrollTo(0,0)
  }, 10)


  // check mode
  // check mode: view|edit
  const urlParams = new URLSearchParams(window.location.search)
  const id = urlParams.get('id')
  const mode = urlParams.get('mode')

  //alert('mode=' + mode + ',id=' + id)

  if (mode == 'view' && id) {

    // if view mode, do it...

  } else {

    // get all staff info and put into #chooseStaff

    let reply = await pumpb.fetchThis(null, '/get-all-staff', 'get')

    if (reply.done) {
      
      let data = reply.data
      PGOJ.allStaff = data
      data.forEach( staff => {
        let selectElem = document.querySelector('#chooseStaff')
        selectElem.innerHTML += `<option value="${staff._id}">${staff.nickName}</option>`
      })


    } else {
      alert('ไม่มีข้อมูลพนักงานเลยค่า เริ่มต้น app ใหม่ใช่ป่าว')
    }
  }

}


async function getPayMonthInfo() {
  /*
      payMonth info is in the pump.conf, tag = businessCalendar
      so we'll get data like:

      {
        startDate: 2025-12-02,
        endDate: 2025-12-31,
        holiday: [ 2025-12-05, 2025-12-10, 2025-12-31 ]
      }

      and we use these to calc wages for holidays, etc.
  */

  PGOJ.payMonth = document.querySelector('#payMonth').value 
  PGOJ.complete = {
    payMonth: PGOJ.payMonth
  }

  try {
    /*
    let myYear, myMonth;

    if (PGOJ.payMonth == '2025-12') {
      myYear = '2025',
      myMonth = 'december'
    }*/
    
    let reply = await pumpb.fetchThis(
      { payMonth: PGOJ.payMonth, masterKey: MASTER_KEY },
      '/get-pay-month-info'
    )
    
    //console.log( reply)

    if (reply.done) {
      //alert( JSON.stringify( reply))
      
      let data = reply.data
      PGOJ.monthInfo = data
      let allHolidays = data.holiday.map( day => {
        return pumpb.getSimpleDate(day)
      })

      document.querySelector('#monthInfo').innerHTML = `
      <span>วันเริ่มต้น</span>
      <span>${data.startDate}</span>
      <span>วันสุดท้าย</span>
      <span>${data.endDate}</span>
      <span>วันหยุดตามประเพณี</span>
      <span>${allHolidays.join(', ')}</span>`

    } else {
      alert('ยังไม่มีข้อมูล Business Calendar ของเดือนนี้ค่ะ ลองเลือกเดือนที่มีข้อมูลอีกทีนะคะ')
      pumpb.clearBrowserBar()
      location.reload()
    }

  } catch(er) {
    console.error(er)
    alert('error')
  }

}
 


async function getStaffInfo() {

  /*
      get staff info and show her payProfile
      user's payProfile tells all rates of her wages scheme

  */


  if (!PGOJ.payMonth) {
    alert('ต้องเลือกเดือนก่อนนะคะ ทีละ step ค่ะ')
    document.querySelector('#chooseStaff').selectedIndex = 0
    return
  }

  clearForm()
  const chooseStaff = document.querySelector('#chooseStaff').value

  if (!chooseStaff.startsWith('-')) {
    try{

      PGOJ.staffId = chooseStaff

      let reply = await pumpb.fetchThis(
        null,
        '/find-staff?id=' + chooseStaff,
        'get'
      )

      if (reply.done) {
        //console.log(reply)
        //alert('got it')

        let data = reply.data
        PGOJ.staffInfo = data
        if (!data.holiday || data.holiday.startsWith('-')) data.holiday = 'อาทิตย์'

        const staffInfo = document.querySelector('#staffInfo')

        


        if (PGOJ.staffInfo.hiringType == 'รายเดือน') {

          staffInfo.innerHTML = `
            <span>ชื่อ นามสกุล</span><span class="tr">${data.firstName} ${data.lastName}</span>
            <span>หมายเลขบัตรประชาชน หรือเอกสารสำคัญ</span><span class="tr">${data.citizenId}</span>
            <span>ประเภทการจ้าง</span>
            <span class="tr">${data.hiringType}</span>
            <span>เงินเดือน</span>
            <span class="tr">${pumpb.getMoneyFormat(data.payProfile.monthlyRate)}</span>
            <span>คิดเป็นค่าจ้าง/ชม</span>
            <span class="tr">${pumpb.getMoneyFormat(data.payProfile.calcHourlyRate)}</span>
            <span>OT วันทำงาน/ชม</span>
            <span class="tr">${pumpb.getMoneyFormat(data.payProfile.workdayOtRate)}</span>
            <span>ค่าทำงานวันหยุด/ชม</span>
            <span class="tr">${pumpb.getMoneyFormat(data.payProfile.holidayWorkRate)}</span>
            <span>OT วันหยุด/ชม</span>
            <span class="tr">${pumpb.getMoneyFormat(data.payProfile.holidayOtRate)}</span>
            <span>วันหยุดประจำสัปดาห์</span>
            <span class="tr">${data.holiday}</span>`

          PGOJ.calc = {
            wages : PGOJ.staffInfo.payProfile.monthlyRate,
            ot    : 0,
            add   : 0,
            deduct: 0,
            net   : PGOJ.staffInfo.payProfile.monthlyRate
          }

        } else if (PGOJ.staffInfo.hiringType == 'รายวัน') {

          // daily staff

          //alert('this is daily staff')
          //return

          const dayMapping = {
            'จันทร์'    : 'monday',
            'อังคาร'   : 'tuesday',
            'พุธ'      : 'wednesday',
            'พฤหัสบดี'  : 'thursday',
            'ศุกร์'     : 'friday',
            'เสาร์'    : 'saturday',
            'อาทิตย์'   : 'sunday'
          }


          let normalWorkdays = pumpb.getWorkDays( PGOJ.payMonth, dayMapping[data.holiday])

          // *** speical for 2025-12
          if (PGOJ.payMonth == '2025-12') normalWorkdays = normalWorkdays - 3 // starts operation on dec2, dec5 = father day, dec10 = constitution day

          let normalPay = data.wages * normalWorkdays
          PGOJ.normalPayForDailyStaff = normalPay


          PGOJ.calc = {
            wages : normalPay,
            ot    : 0,
            add   : 0,
            deduct: 0,
            net   : normalPay
          }



          staffInfo.innerHTML = `
            <span>ชื่อ นามสกุล</span><span class="tr">${data.firstName} ${data.lastName}</span>
            <span>หมายเลขบัตรประชาชน หรือเอกสารสำคัญ</span><span class="tr">${data.citizenId}</span>
            <span>ประเภทการจ้าง</span>
            <span class="tr">${data.hiringType}</span>
            <span>ค่าแรง/วัน ${pumpb.getMoneyFormat(data.wages)} x ${normalWorkdays} วันทำงานปกติเดือนนี้ = </span>
            <span class="tr">${pumpb.getMoneyFormat( normalPay) }</span>
            <span>คิดเป็นค่าจ้าง/ชม</span>
            <span class="tr">${pumpb.getMoneyFormat(data.payProfile.calcHourlyRate)}</span>
            <span>OT วันทำงาน/ชม</span>
            <span class="tr">${pumpb.getMoneyFormat(data.payProfile.workdayOtRate)}</span>
            <span>ค่าทำงานวันหยุด/ชม</span>
            <span class="tr">${pumpb.getMoneyFormat(data.payProfile.holidayWorkRate)}</span>
            <span>OT วันหยุด/ชม</span>
            <span class="tr">${pumpb.getMoneyFormat(data.payProfile.holidayOtRate)}</span>
            <span>วันหยุดประจำสัปดาห์</span>
            <span class="tr">${data.holiday}</span>`

        }
        


        // get OT data
        {
          
          let reply = await pumpb.fetchThis(
            { 
              payMonth: PGOJ.payMonth, 
              staffNickName: PGOJ.staffInfo.nickName,
              //masterKey: MASTER_KEY
            },
            '/find-ot'
          )
          
          if (reply.done) {

            let data = reply.data
            let otBoxEl = document.querySelector('#otBoxGrid')
            let sum = 0


            data.forEach( ot => {

              let rateField;
              switch (ot.workType) {
                case 'OT วันทำงาน':
                  rateField = 'workdayOtRate'
                  break;
                case 'OT วันหยุด':
                  rateField = 'holidayOtRate'
                  break;
                case 'ทำงานวันหยุด':
                  rateField = 'holidayWorkRate'
                  break;
                default:
                  rateField = 'workDayOtRate'
              }

              let thisFee = pumpb.calcHourlyFees(
                    ot.lengthTime, 
                    PGOJ.staffInfo.payProfile[rateField]
                  )

              sum += thisFee
              PGOJ.calc.ot = sum

              otBoxEl.innerHTML += `
              <span>${pumpb.getSimpleDate( ot.otDate)}</span>
              <span>${ot.workType}</span>
              <span>${ot.startTime}</span>
              <span>${ot.stopTime}</span>
              <span>${ot.lengthTime}</span>
              <span class="tr">${
                pumpb.getMoneyFormat( 
                  thisFee 
                )
              }</span>`
            })

            otBoxEl.innerHTML += `
            <span style="grid-column: span 5" class='tc'>รวม</span>
            <span class="tr">${pumpb.getMoneyFormat(sum)}</span>`


          } else {
            //alert('not found ot')
          }

        }


        // addition like benefits: เบี้ยขยัน ค่าแต่งหน้า ค่าผ่าน audit ...
        {

          let reply = await pumpb.fetchThis(
            { 
              staffNickName : PGOJ.staffInfo.nickName , 
              payMonth      : PGOJ.payMonth 
            },
            '/find-benefit'
          )
          
          if (reply.done) {
            // we should get data in array of benefit docs

            let elem = document.querySelector('#otherAddGrid')
            let data = reply.data
            let count = 0, sum = 0
            
            data.forEach( ben => {
              count++
              elem.innerHTML = elem.innerHTML + `<span>${count}</span>
              <span>${ben.description}</span>
              <span class="tr">${pumpb.getMoneyFormat(ben.value)}</span>`

              sum += ben.value
              PGOJ.calc.add = sum
            })

            elem.innerHTML += `<span style="grid-column: span 2" class="tc">รวม</span>
            <span class="tr">${pumpb.getMoneyFormat(sum)}</span>`

          }


        }




        // social security deduction, other deduction
        {

          let elem = document.querySelector('#deductGrid')
          let count = 0, sum = 0

          if (PGOJ.staffInfo.hiringType == 'รายเดือน') {
            
            count++
            
            if (PGOJ.staffInfo.amountDeductForSocialSecFund) {
            
              elem.innerHTML += `<span>${count}</span>
              <span>หักเงินสมทบประกันสังคม 5% ของเงินเดือน (หรือรายได้ปกติทั้งเดือน)</span>
              <span class="tr">-${pumpb.getMoneyFormat( PGOJ.staffInfo.amountDeductForSocialSecFund)}</span>`

              sum = - PGOJ.staffInfo.amountDeductForSocialSecFund
              //PGOJ.calc.deduct = 

            } 

          } else if (PGOJ.staffInfo.hiringType == 'รายวัน') {

            count++
            const socialSecDeduct = pumpb.getRound( PGOJ.normalPayForDailyStaff * 0.05)

            elem.innerHTML += `<span>${count}</span>
            <span>หักเงินสมทบประกันสังคม 5% ของเงินเดือน (หรือรายได้ปกติทั้งเดือน)</span>
            <span class="tr">-${pumpb.getMoneyFormat( socialSecDeduct)}</span>`

            sum = - socialSecDeduct
            //PGOJ.calc.deduct = - socialSecDeduct

          }

          // other deduct ...

          let reply = await pumpb.request(
            { 
              masterKey : MASTER_KEY, 
              fromStaff : PGOJ.staffInfo.nickName,
              forMonth  : PGOJ.payMonth 
            },
            '/find-deduct'
          )

          //console.log(reply)

          if (reply.done) {
            
            // the response must be in array

            if (reply.data.length) {

              let data = reply.data
              data.forEach( deduc => {

                count++
                elem.innerHTML += `<span>${count}</span>
                  <span>${deduc.description}</span>
                  <span class="tr">-${pumpb.getMoneyFormat( deduc.deductAmount)}</span>`

                sum -= Number( deduc.deductAmount)

              })

            }
          } else {
            alert('not found deduct')
          }


          // sum the grid
          elem.innerHTML += `<span style="grid-column: span 2" class="tc">รวม</span>
          <span class="tr">${pumpb.getMoneyFormat( sum)}</span>`
          PGOJ.calc.deduct = sum

          
        }
        

        // calc the net

        {

          PGOJ.calc.net = Number(PGOJ.calc.wages) + Number(PGOJ.calc.ot) + Number(PGOJ.calc.add) + Number(PGOJ.calc.deduct) 

          document.querySelector('#normalWagesSum').textContent = pumpb.getMoneyFormat(PGOJ.calc.wages)
          document.querySelector('#otSum').textContent = pumpb.getMoneyFormat(PGOJ.calc.ot)
          document.querySelector('#otherAddSum').textContent = pumpb.getMoneyFormat(PGOJ.calc.add)
          document.querySelector('#deductWagesSum').textContent = pumpb.getMoneyFormat(PGOJ.calc.deduct)
          document.querySelector('#netWagesSum').textContent = pumpb.getMoneyFormat(PGOJ.calc.net)


        }


        // calc tax

        {


          const estimate = PGOJ.staffInfo.estimateAnnualIncome2025
          const expense = pumpb.getRound(Number(estimate) * 0.5)
          const allowance = 60000
          const socialSec = pumpb.getRound( PGOJ.staffInfo.amountDeductForSocialSecFund * 12)
          const net = pumpb.getRound(estimate - expense - allowance - socialSec)

          //console.log(estimate, expense, allowance, socialSec, net)
          let exempt;
          if (net < 150000) {
            // this is exempt
            //alert('exempt')
            exempt = true
          } else {
            //alert('not exempt')
            exempt = false
          }

          PGOJ.incomeTaxCalc = {
            estimateAnnualIncome: estimate,
            personalExpenses: expense,
            personalAllowance: allowance,
            annualSocialSecFund: socialSec,
            netIncomeForTaxCalc: net 
          }

          document.querySelector('#estimateAnnualIncome').textContent = pumpb.getMoneyFormat(estimate)
          document.querySelector('#personalExpense').textContent = pumpb.getMoneyFormat(expense)
          document.querySelector('#personalAllowance').textContent = pumpb.getMoneyFormat(allowance)
          document.querySelector('#socialSecFundDeduct').textContent = pumpb.getMoneyFormat(socialSec)
          document.querySelector('#netToCalcIncomeTax').textContent = pumpb.getMoneyFormat(net)
          document.querySelector('#deductForPersonalIncomeTax').textContent = exempt? 'ยกเว้นการหักภาษี ภงด.' : 0

        }
        

        // จ่ายสุทธิ, net pay
        document.querySelector('#netWagesPay').textContent = pumpb.getMoneyFormat(PGOJ.calc.net)




      } else {
        alert('not found')
      }

    } catch(er) {
      console.error(er)
      alert('error')
    }
  } else {
    alert('กรุณาเลือกพนักงานด้วยค่ะ')
    return
  }
}



function clearForm() {
  // clear form as user change staff

  //document.querySelector('#payMonth').value = ''
  //document.querySelector('#monthInfo').innerHTML = ''

  let otGridHeader = `<span>วันที่</span><span>รายการ</span><span>เริ่ม</span><span>หยุด</span><span>รวมเวลา</span><span class="tr">คิดเป็นเงิน</span>`
  let addGridHeader = `<span>ลำดับ</span><span>รายการ</span><span class="tr">ยอดเพิ่ม</span>`
  let deductGridHeader = `<span>ลำดับ</span><span>รายการ</span><span class="tr">ยอดหัก</span>`

  document.querySelector('#staffInfo').innerHTML = ''
  document.querySelector('#otBoxGrid').innerHTML = otGridHeader
  document.querySelector('#otherAddGrid').innerHTML = addGridHeader
  document.querySelector('#deductGrid').innerHTML = deductGridHeader
  document.querySelector('#normalWagesSum').textContent = ''
  document.querySelector('#otSum').textContent = ''
  document.querySelector('#deductWagesSum').textContent = ''
  document.querySelector('#netWagesSum').textContent = ''


  document.querySelector('#netWagesPay').textContent = ''
  document.querySelector('#note').value = ''
  document.querySelector('#approvedBy').value = ''

}




function approveWagesPay() {

  // approve this wages pay

  if (document.querySelector('#payMonth').value == '' || document.querySelector('#chooseStaff').value.startsWith('-') || document.querySelector('#approvedBy').value == '') {
    alert('อันที่มี * ต้องมีข้อมูลค่ะ')
    return
  }

  if ( !pumpb.payoutApprovalUser.includes( document.querySelector('#approvedBy').value) ) {
    alert('ต้องให้ user ที่มีสิทธิ์อนุมัติ เป็นผู้อนุมัติ ค่ะ')
    return
  }

  // pass

  document.querySelectorAll('select').forEach( el => el.disabled = true)
  document.querySelectorAll('input').forEach( el => el.disabled = true)
  document.querySelectorAll('textarea').forEach( el => el.disabled = true)
  document.querySelector('#approveButton').disabled = true
  document.querySelector('#approveButton').disabled = true
  document.querySelector('#convertButton').disabled = false
  document.querySelector('#clearButton').disabled = true


  alert('การจ่ายเงินค่าจ้างและสวัสดิการแก่พนักงานรายนี้ ได้รับการอนุมัติแล้ว ขอบคุณค่ะ')

  //document.querySelector('#pageTitle').textContent = "ใบแสดงการจ่ายเงินเดือน"
  //document.querySelector('#pageBrief').textContent = 'เอกสารนี้ออกโดย บจ. นวประชา 2025 ให้กับพนักงานเป็นรายคน เพื่อแสดงรายละเอียดการจ่ายค่าจ้าง ในแต่ละเดือน'

  //document.querySelectorAll('[bottom-of-form]').forEach( el => el.hidden = true)
}




function makePayslip() {

  // makes this page a payslip

  document.querySelector('#pageTitle').textContent = 'ใบแสดงการจ่ายค่าจ้างแก่พนักงาน'
  document.querySelector('#pageTitle').style.textAlign = 'center'
  document.querySelector('#pageBrief').textContent = 'เอกสารนี้ ออกโดย บจ. นวประชา 2025 เพื่อแสดงรายละเอียดการจ่ายค่าจ้าง สวัสดิการ ต่างๆ ในแต่ละเดือน และมอบให้พนักงานเฉพาะรายไว้ เพื่อเป็นข้อมูล'

  document.querySelectorAll('[bottom-of-form]').forEach( el => el.hidden = true)
  document.querySelector('#approvedBy').style.display = 'none'
  document.querySelector('#footer').hidden = false

  let payslipHtml = pumpb.getThisPageStatic()
  pumpb.previewNewTab( payslipHtml)

  console.log(payslipHtml)

}

















</script>
</body>
</html>
  
