<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>All Payslip</title>
<script src="conf.js"></script>
<script src="pump-b.js"></script>
<script src="/js/xdev-b.js"></script>
<link href="/js/w3.css" rel="stylesheet" type="text/css">
<link href="/js/material-x.css" rel="stylesheet" type="text/css">
<link href="pump.css" rel="stylesheet" type="text/css">
<style>
  /* put local styles here */
</style>
</head>
<body>

<div class="world-space">

  <!-- title / page name -->
  <div id="page_title" style="margin-bottom: 24px;">
    <div style="color: blue; background-color: white; z-index: 50; font-size: 1.5rem; font-style: bold">All Payslip*</div>
    <p id="page_brief" class="small">แสดง Payslip ของพนักงานในแต่ละเดือน แล้วกดดูบนจอได้</p>
  </div>


  <!-- find -->
  <div style="display: grid; grid-template-columns: 80% 20%; align-items: center;">
    <input type="text" style="width: 100%; border-radius: 10px 0 0 10px; font-size: 1.2rem;" class="w3-input w3-border" placeholder="ค้นอะไรก็ได้ที่เห็นบนตาราง ...">
    <button class="w3-button w3-blue" 
    style="border-radius: 0 10px 10px 0; padding: 11px 0"><img src="/icon-x/Search.svg" width="24"></button>
  </div>


  <!-- top action -->
  <div id="top_act" style="display: none; align-items: center; justify-content: space-around; margin-bottom: 24px;">
    <button id="edit_act" class="w3-button" style="padding: 4px 8px; background-color: #fdd835;" 
    onclick="">Edit</button>
    <button id="delete_act" class="w3-button" style="padding: 4px 8px; background-color: #757575;" disabled>Delete</button>
  </div>



  <!-- form -- >
  <div class="form-space" style="grid-template-columns: 1fr 2fr; margin-top: 32px; width: 100%">

    <label>เดือน</label>
    <select id="select_month" class="w3-select">
      <option>2025-12</option>
    </select>


   
  </div-->


  <div class="form-space" style="display: grid; grid-template-columns: 120px 1fr; width: 100%; margin-top: 32px;">
    <label>เดือน</label>
    <select id="select_month" class="w3-select w3-border">
      <option>2025-12</option>
    </select>

    <div id="report_grid" style="grid-column: span 2; grid-template-columns: 1fr 7fr;" class="grid-space">

      <span class="tc">ลำดับ</span><span class="tc">รายการ</span>

    </div>

  </div>


  <!-- form action -- >
  <div id="form_act" style="display: flex; align-items: center; justify-content: space-around; margin-top: 32px">
    <button class="w3-button w3-blue">Confirm</button>
    <button class="w3-button w3-yellow">Clear</button>
  </div-->



</div>



<!-- page action -->
<div id="page_act" style="padding: 4px; position: fixed; left: 0; bottom: 0; ">
  <img id="back_act" src="/icon/u-turn.svg" style="width: 32px; height: 32px; cursor: pointer;" 
  onclick="history.back()">
</div>


<script>
//////////////////////////////////////////////////////////////////


const PGOJ = {}
let MODE = 'new';

// this code scroll page to top after reload
window.onload = async () => {

  // scroll to top on reload
  setTimeout( () => {
    window.scrollTo(0,0)
  }, 10)


  // check mode
  // check mode: view|edit
  //const urlParams = new URLSearchParams(window.location.search)
  let myQuery = new pumpb.MyQuery
  const id = myQuery.get('id')
  const mode = myQuery.get('mode')

  //alert('mode=' + mode + ',id=' + id)

  if (mode == 'view' && id) {

    // if view mode, do it...

  } else {

    // normal mode, so we load all payslip data from pump.wagesPay

    try {

      let month = document.querySelector('#select_month').value 
      if (!month) {
        alert('ต้องเลือกเดือนก่อนนะคะ')
        return
      }

      // pass

      let reply = await pumpb.request(
        { 
          month: month,
          masterKey: MASTER_KEY
        },
        '/get-payslip'
      )

      if (reply.done) {

        let reportElem = document.querySelector('#report_grid')
        let data = reply.data
        PGOJ.data = data
        let count = 0

        data.forEach( approve => {

          count++
          reportElem.innerHTML += `<span class="tc">${count}</span><span class="pointer hover-it" data-id="${approve._id}">${approve.staffInfo.fullName} (${approve.staffNickName})</span>`

        })  

      } else {
        alert('ไม่มี Payslip ของเดือนที่เลือกนี้เลยค่ะ')
      }

    } catch(er) {
      console.error(er)
      alert('มีปัญหาทางเทคนิคค่ะ')
    }



  }


  // watch the click on the report grid

  document.querySelector('#report_grid').addEventListener('click', async (event) => {

    if (event.target.dataset.id) {
      //alert(event.target.dataset.id)
      /*
      try {

        let reply = await pumpb.request(
          { 
            wagesPayId: event.target.dataset.id, 
            masterKey: MASTER_KEY 
          },
          '/get-payslip'
        )

        if (reply.done) {

          pumpb.previewNewTab( reply.data)

        } else {
          alert('ไม่พบ payslip ของคนนี้เลยค่ะ ต้องมีอะไรผิดพลาดแน่ๆ')
        }

      } catch(er) {
        console.error(er)
        alert('มีปัญหาทางเทคนิคค่ะ')
      }
        */ 

      let wagesPay = PGOJ.data.find( v => v._id == event.target.dataset.id)
      pumpb.previewNewTab( wagesPay.payslip)
    }

  })

}

</script>
</body>
</html>
  
