<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Add Product</title>
  <script src="conf.js"></script>
  <script src="pump-b.js"></script>
  <script src="/js/xdev-b.js"></script>
  <link href="/js/w3.css" rel="stylesheet" type="text/css">
  <link href="/js/material-x.css" rel="stylesheet" type="text/css">

<style>
  *,
  *::before,
  *::after { box-sizing: border-box; }
  html { font-size: 16px; }
  small { font-size: 0.8rem }
  label { font-size: 0.8rem }
  .small { font-size: 0.8rem }
  .medium { font-size: 1.0rem }
  .default { font-size: 1.25rem }
  .large { font-size: 1.5rem }
  .xlarge { font-size: 2.0rem }

  .world-space { max-width: 800px; margin: auto; }
  .my-form > input {
    width: 100%; padding: 4px;
  }
  .my-form input,
  .my-form textarea,
  .my-form select,
  .my-form option {
    font-size: 1.25rem;
  }

  .line-in-form {
   grid-column: span 2; width: 100%; border-top: 1px solid gray; margin: 16px 0;
  }

  .hover-it:hover { background-color: #b2ebf2;}
  .indigo { color: #5c6bc0 }

</style>
</head>
<body>

<div style="padding: 0 16px; color: blue; background-color: white; z-index: 50; font-size: 1.5rem; font-style: bold">จ่ายค่าจ้างพนักงาน*</div>

<div class="world-space" style="padding: 0 16px; margin-top: 32px">
  
  <div id="setting">
    <p class="indigo">Set up Variables</p>
    <div style="display: grid; grid-template-columns: auto auto; align-items: center; gap: 4px">
      <label>เวลาทำงานมาตรฐานของช่วงเวลาที่คำนวนนี้ กี่ชั่วโมง?</label>
      <input id="setStdTotalWorkHour" type="text" class="w3-input w3-border" placeholder="เช่น 01:30" value="40:00:00">
      <label>เวลาที่ + เพิ่มให้พนักงานทุกคน ในช่วงทำงานนี้ กี่ชั่วโมง</label>
      <input id="setStdAdjustHour" type="text" class="w3-input w3-border" placeholder="เช่น 01:30" value="0:0:0">
    </div>

  </div>
  <hr>
  <div id="dataSource">
    <p class="indigo">Upload Attendance Data</p>
    <p class="small">ใช้ไฟล์ csv ที่ได้จากเครื่อง Finger Scan โดยเลือกข้อมูลของเดือนที่ต้องการ</p>
  
    <input id="csvFile" type="file" onchange="readCsvFile(this)">
  </div>


  <hr>

  <div id="calculation">
    <p class="indigo">Calculation</p>
    <div id="showDataHere"></div>



  </div>
  
    


    

    <!----------------------------------------------------------
    <hr class="line-in-form">

    <label>Note</label>
    <textarea id="note" rows="4" placeholder=""></textarea>
    
    <label>ป้อนข้อมูลโดย*</label>
    <input id="enterBy" type="text" placeholder="เช่น @sern, @john ...">

    -->




  <!-- form action -- >
  <div style="display: flex; align-items: center; justify-content: space-around; margin-top: 40px; margin-bottom: 60px;">
    <button class="w3-button w3-blue" 
    onclick="addProduct()">Save</button>
    <button class="w3-button w3-light-grey" 
    onclick="location.reload()">Cancel / Clear</button>
  </div-->



</div>



<!-- page action -->
<div style="padding: 4px; position: fixed; left: 0; bottom: 0; ">
  <img src="/icon/u-turn.svg" style="cursor: pointer; width: 32px;" 
  onclick="history.back()">
</div>


<script>
///////////////////////////////////////////////////////////////////

let CSV, OJ, OJ2;



// this code scroll page to top after reload
window.onload = () => {
  setTimeout( () => {
    window.scrollTo(0,0)
  }, 10)
}



// DEFINITION

const domain = PUMP_DOMAIN //'http://192.168.1.111:4000';
const showPicHere = document.getElementById('showPicHere');


//const lastEdit = new Date
//document.getElementById('lastEdit').value = lastEdit




/*
async function fetchThis( data, api ) {
    
  let response = await fetch( domain + api, {
    method  : 'POST',
    headers : {'Content-Type':'application/json'},
    body    : JSON.stringify( data )

  })
  
  return response.json()

}
*/

async function addProduct() {
  /*
      send data to /add-product
      get { done: true|false, msg: ... ,data: [_id] }
  */

  let data = {
    pic: document.querySelector('#showPicHere').src,
    code: document.querySelector('#code').value,
    name: document.querySelector('#name').value,
    description: document.querySelector('#description').value,
    brand: document.querySelector('#brand').value,
    barCode: document.querySelector('#barCode').value,
    partnerCode: document.querySelector('#partnerCode').value,
    otherCode: document.querySelector('#otherCode').value,
    category: document.querySelector('#category').value,
    uom: document.querySelector('#uom').value,
    unitPrice: document.querySelector('#unitPrice').value,
    currency: document.querySelector('#currency').value,
    minOrder: document.querySelector('#minOrder').value,
    mustStock: document.querySelector('#mustStock').checked,
    minStock: document.querySelector('#minStock').value,
    warranty: document.querySelector('#warranty').value,
    returnBy: document.querySelector('#returnBy').value,
    supplierId: document.querySelector('#supplier').getAttribute('supplier-id'),
    status: document.querySelector('#status').value,
    start: document.querySelector('#start').value,
    note: document.querySelector('#note').value,
    enterBy: document.querySelector('#enterBy').value
  }

  if (!data.code || !data.name || !data.description || !data.category || !data.uom || !data.unitPrice || !data.enterBy ) {
    alert('โปรดป้อนข้อมูลทุกช่องที่มีเครื่องหมาย * ขอบคุณค่ะ')
    return
  }

  // pass - basic validation

  try {

    let reply = await pumpb.fetchThis( data, '/add-product')

    if (reply.done) {
      alert(`เรียบร้อย - เพิ่มสินค้าชื่อ ${data.name} เรียบร้อยแล้วค่ะ`)
      location.reload()
    } else {
      alert(`ไม่สามารถ Save ข้อมูลได้ โปรดลองอีกครั้ง`)
    }

  } catch(er) {
    alert('Error - มีปัญหาทางเทคนิคค่ะ โปรดลองอีกครั้ง')
  }
  
}



async function findSupplier() {
  // find and show it on #supplier

  let inputEl = document.querySelector('#findSupplierInput')

  if (!inputEl.value) {
    alert('รบกวนใส่ชื่อ Supplier ด้วยค่ะ')
    return
  }

  try {

    let reply = await pumpb.fetchThis(null, '/find-partner?name=' + inputEl.value, 'get')

    if (reply.done) {

      let supEl = document.querySelector('#supplier')
      supEl.textContent = `${reply.data.name}`
      supEl.setAttribute('supplier-id', reply.data._id)

    } else {
      alert('ไม่พบข้อมูลค่ะ โปรดลองชื่ออื่นดูอีกครั้ง')
      document.querySelector('#findSupplierInput').value = ''
      document.querySelector('#findSupplierInput').focus()
    }

  } catch(er) {
    alert('Error - มีปัญหาทางเทคนิคค่ะ โปรดลองอีกครั้ง')
  }

}


function clearSupplier() {
  // clear supplier selection from search box
  document.querySelector('#findSupplierInput').value = ''
  document.querySelector('#supplier').textContent = ''
  document.querySelector('#supplier').setAttribute('supplier-id','')
}




async function readCsvFile( inputElem ) {
  
  CSV = await xb.readTextFile( inputElem)
  OJ = xb.csvObj( CSV)
  
  OJ2 = []

  OJ.forEach( v => {
    if (v.time) {
      
      v.jsTime = new Date( v.time).getTime()
      v.isoDate = pumpb.getLocalIsoDate( new Date( v.time)).split('T')[0]

      OJ2.push({ 
        fingerCode: v.code, 
        staffName : v.name.split(' ')[0],
        date      : v.isoDate, 
        time      : pumpb.getSimpleTime( new Date(v.jsTime) ),
        timeStamp : v.jsTime 
      })

    }
  })

  const dateList = Array.from(
    new Set(
      OJ2.map(v => v.date)
    )
  )
  //console.log( dateList)

  const fingerList = Array.from(
    new Set(
      OJ2.map(v => v.fingerCode)
    )
  )  
  //console.log( fingerList)
  

  const show = document.querySelector('#showDataHere')

  fingerList.forEach( finger => {
    let staffInfo = OJ2.find(v => v.fingerCode == finger)
    let staffName = staffInfo.staffName
    show.innerHTML += '<div><u>' + finger + ` (${staffName})</u></div>`
    
    let sumStay = 0
    dateList.forEach( date => {
      
      let pair = OJ2.filter(v => v.fingerCode == finger && v.date == date)
      if (pair.length != 2) {
        
        show.innerHTML += `<div>${date} -- no data pair --</div>`
      
      } else {
        
        let stay = pair[1].timeStamp - pair[0].timeStamp
        sumStay += stay

        show.innerHTML += `<div>${date} in=${pair[0].time} out=${pair[1].time} stay=${pumpb.getDuration( stay )}</div>`
      }

    })

    let diff = pumpb.getDuration( 
      sumStay - pumpb.getMilli( document.querySelector('#setStdTotalWorkHour').value )
    )

    show.innerHTML += `<div id="box${finger}">
    <div>Sum stay = <span id="sum${finger}" style="text-decoration: underline">${ pumpb.getDuration( sumStay)}</span></div>
    <div>ปรับ เพิ่ม/ลด = <input id="adjust${finger}" value="00:00" type="text" style="width: 100px" oninput="calcFinalStay(this)"> (รูปแบบ 00:00:00)</div>
    <div>Final Stay = <span id="final${finger}">${ pumpb.getDuration( sumStay )}</span></div>
    <div>Diff from Standard Work Hour = <span id="diff${finger}">${ diff }</span></div>
    <button id="confirm${finger}" onclick="confirmAttendance(this)">Confirm</button>
    </div>
    <hr class="line-in-form">`

  })


}


function calcFinalStay( adjustElem ) {
  // adjustElem.id will be like 'adjust6801' so we take value from sum6801 + adjust6801 and put to final6801

  if (adjustElem.value == 0) return

  let fingerCode = adjustElem.id.replace('adjust','')
  let sumElem = document.querySelector(`#${adjustElem.id.replace('adjust','sum')}`)
  let finalElem = document.querySelector(`#${adjustElem.id.replace('adjust','final')}`) 

  let stdWorkHour = pumpb.getMilli( 
    document.querySelector('#setStdTotalWorkHour').value )
  
  let stdAdjustHour = pumpb.getMilli(
    document.querySelector('#setStdAdjustHour').value )
  
  let sumHour = pumpb.getMilli( sumElem.textContent)
  let adjustHour = pumpb.getMilli( adjustElem.value)
  let finalHour = sumHour + adjustHour + stdAdjustHour
  let diffHour = finalHour - stdWorkHour
  finalElem.textContent = pumpb.getDuration( finalHour)
  document.querySelector(`#diff${fingerCode}`).textContent = pumpb.getDuration( diffHour)
}



function confirmAttendance( confirmButtonElem ) {
  // disable all change and save this staff attendance to db
  document.querySelector(`#adjust${ confirmButtonElem.id.replace('confirm','')}`).disabled = true;
  confirmButtonElem.disabled = true
}




</script>
</body>
</html>