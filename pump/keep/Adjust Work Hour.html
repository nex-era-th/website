<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Add/Deduct Fund</title>
<script src="conf.js"></script>
<script src="pump-b.js"></script>
<script src="/js/xdev-b.js"></script>
<link href="/js/w3.css" rel="stylesheet" type="text/css">
<link href="/js/material-x.css" rel="stylesheet" type="text/css">
<link href="pump.css" rel="stylesheet" type="text/css">
<style>
  /* put local styles here */
</style>
</head>
<body>

<div class="world-space" style="padding: 0 16px;">

  <!-- title -->
  <div style="margin-bottom: 24px;">
    <div id="pageTitle" style="color: blue; background-color: white; z-index: 50; font-size: 1.5rem; font-style: bold">Adjust Work Hour</div>
    <p id="pageBrief" class="tiny grey">ป้อนข้อมูล เงินเพิ่ม/เงินหัก ของพนักงาน เช่นพนักงานทำ OT หรือทำงานวันหยุด ก็ต้องมาป้อนในหน้านี้ หรือหักเงินเช่น ขาด ลา หรือกรณีอื่นๆ เป็นต้น</p>
  </div>


  <!-- form -->
  <div class="form-space" style="display: grid; grid-template-columns: 30% 70%; align-items: center; gap: 4px; margin-top: 32px">


    <label>จะเพิ่มหรือจะหัก</label>
    <select class="w3-select">
      <option>เพิ่มเงิน</option>
      <option>หักเงิน</option>
    </select>

    <label>กำหนดสำหรับ</label>
    <div id="dayOrMonthRadioBox" style="display: flex; flex-wrap: wrap; align-items: center; gap: 24px">
      <span><input name="dayOrMonth" type="radio" class="w3-radio" checked value="day"> วัน</span>
      <span><input name="dayOrMonth" type="radio" class="w3-radio" value="month"> เดือน</span>
    </div>

    <hr class="line-in-form">

    <label>เลือกเวลา*</label>
    <div style="display: flex; flex-direction: column;">
      <input id="whichDay" type="date" class="w3-input">
      <input id="whichMonth" type="month" class="w3-input" style="display: none">
    </div>

    <hr class="line-in-form">

    <small style="grid-column: span 2;">เลือกพนักงานได้หลายคน</small>

    <label>เลือกพนักงาน*</label>
    <select id="selectStaff" class="w3-select" onchange="showStaff(this)">
      <option>-----</option>
      <option>ทุกคน</option>
      <option>ทุกคน - แผนกบริการน้ำมัน</option>
      <option>ทุกคน - แผนกร้านกาแฟอเมซอน</option>
      <option>ทุกคน - แม่บ้าน</option>
      <option>ลบอันหลังสุด</option>
      <option>ลบทั้งหมด</option>
      <option>-----</option>
    </select>
    <div id="showStaffHere" style="padding: 16px; grid-column: span 2;">
      <!-- staff shows here -->
    </div>


    <hr class="line-in-form">

    <label>ประเภทรายการ</label>
    <select id="typeOfAct" class="w3-select">
      <option>-----</option>
      <option>ค่าล่วงเวลาวันทำงาน</option>
      <option>ค่าล่วงเวลาวันหยุด</option>
      <option>ค่าทำงานวันหยุด</option>
      <option>ขาดงาน</option>
      <option>ลาแบบหักเงิน</option>
      <option>ลาแบบไม่หักเงิน</option>
      <option>มาสาย</option>
    </select>


    <label>เวลาเริ่ม</label>
    <input id="startTime" type="time" class="w3-input" onchange="calcTime()">
    <label>เวลาหยุด</label>
    <input id="stopTime" type="time" class="w3-input" onchange="calcTime()">
    <label>รวมเวลา</label>
    <input id="lengthTime" type="text" class="w3-input" disabled>


    <hr class="line-in-form">
    

    <label>Note</label>
    <textarea id="note" rows="3" placeholder="เช่น ช่วงเทศกาลปีใหม่ ลูกค้ามากผิดปกติ"></textarea>
    <label>ป้อนข้อมูลโดย*</label>
    <input id="enterBy" type="text" class="w3-input" placeholder="เช่น @fern">
  </div>


  <!-- form action -->
  <div id="formActBox" style="display: flex; align-items: center; justify-content: space-around; margin-top: 32px">
    <button class="w3-button w3-blue"
    onclick="confirmOt()">Confirm</button>
    <button class="w3-button w3-yellow"
    onclick="pumpb.clearBrowserBar(); location.reload()">Clear</button>
  </div>



</div>

<!-- page action -->
<div style="padding: 4px; position: fixed; left: 0; bottom: 0; ">
  <img src="/icon/u-turn.svg" style="width: 32px; height: 32px; cursor: pointer;" 
  onclick="location.href = 'index.html';">
</div>


<script>
//////////////////////////////////////////////////////////////////

let MODE = 'new';
let OT_ID;

// this code scroll page to top after reload
window.onload = async () => {

  // scroll to top on reload
  setTimeout( () => {
    window.scrollTo(0,0)
  }, 10)



  // listen the #dayOrMonthRadioBox
  document.querySelector('#dayOrMonthRadioBox').addEventListener('change', event => {
    if (event.target.type === 'radio') {
      
      let selected = document.querySelector('input[name="dayOrMonth"]:checked')

      if (selected) {
        //alert(selected.value)

        if (selected.value == 'day') {
          document.querySelector('#whichDay').style.display = 'block'
          document.querySelector('#whichMonth').style.display = 'none'
        } else { // month 
          document.querySelector('#whichDay').style.display = 'none'
          document.querySelector('#whichMonth').style.display = 'block'
        }

      } else {
        return null
      }

    }
  })




  // always load the staff data to make the select choices
  try {

    let reply = await pumpb.fetchThis( null, '/get-all-staff', 'get')
    if (reply.done) {
      let data = reply.data

      data.forEach( staff => {
        let newElem = document.createElement('option')
        newElem.textContent = staff.nickName
        document.querySelector('#selectStaff').append(newElem)
      })

    } else {
      alert('ไม่มีข้อมูลพนักงานเลยค่ะ คงต้อง add เข้าไปก่อนป่าว')
    }

  } catch(er) {
    console.error('error : fetch /get-all-staff', er)
    alert('มีปัญหาทางเทคนิคค่ะ ลองกด refresh หน้าจออีกทีดีมั๊ยคะ ถ้าไม่ได้อาจเพราะ server มีปัญหา')
  }







  // check mode
  // check mode: view|edit
  //const urlParams = new URLSearchParams(window.location.search)
  let myQuery = new pumpb.MyQuery
  const id = myQuery.get('id') //urlParams.get('id')
  MODE = myQuery.get('mode') || 'new' //urlParams.get('mode')

  //alert('mode=' + mode + ',id=' + id)


  if (MODE == 'new') {

    // may do nothing here    


  } else if (MODE == 'view' && id) {

    // if view mode, do it...
    //alert(id)

    try {

      let reply = await pumpb.fetchThis(
        { _id: id } , '/find-ot'
      )

      if (reply.done) {
        let data = reply.data

        document.querySelector('#selectStaff').value = data.staffNickName
        document.querySelector('#otDate').value = data.otDate
        document.querySelector('#startTime').value = data.startTime
        document.querySelector('#stopTime').value = data.stopTime
        document.querySelector('#otDate').value = data.otDate
        document.querySelector('#lengthTime').value = data.lengthTime
        document.querySelector('#staffAgreed').checked = data.staffAgreed
        document.querySelector('#reason').value = data.reason
        document.querySelector('#enterBy').value = data.enterBy

        // disable
        document.querySelectorAll('input').forEach( el => el.disabled = true)
        document.querySelectorAll('textarea').forEach( el => el.disabled = true)
        document.querySelectorAll('select').forEach( el => el.disabled = true)
        document.querySelector('#formActBox').querySelectorAll('button').forEach( el => el.disabled = true)

        // setting
        document.querySelector('#pageTitle').textContent = 'ข้อมูล OT ของพนักงาน'
        document.querySelector('#pageBrief').textContent = ''

        pumpb.clearBrowserBar()


      } else {
        alert('ไม่มีข้อมูล OT นี้ค่ะ')
      }

    } catch(er) {
      console.error(er)
      alert('มีปัญหาทางเทคนิคค่ะ')
    }

  }

}





function calcTime() {

  const start = document.querySelector('#startTime').value
  const stop = document.querySelector('#stopTime').value
  if ( start && stop ) {

    document.querySelector('#lengthTime').value = pumpb.getLengthFrom2times( start, stop)

  } else {
    //alert('ต้องใส่เวลาเริ่ม ด้วยค่ะ')
  }

}


async function confirmOt() {
  let data = {
    staffNickName: document.querySelector('#selectStaff').value,
    otDate: document.querySelector('#otDate').value,
    startTime: document.querySelector('#startTime').value,
    stopTime: document.querySelector('#stopTime').value,
    lengthTime: document.querySelector('#lengthTime').value,
    staffAgreed: document.querySelector('#staffAgreed').checked,
    reason: document.querySelector('#reason').value,
    enterBy: document.querySelector('#enterBy').value
  }

  if (data.staffNickName.startsWith('-') || !data.otDate || !data.startTime || !data.stopTime || !data.staffAgreed || !data.enterBy) {
    alert('ช่องที่มี * ต้องมีข้อมูลค่ะ')
    return
  }

  try {

    if (MODE == 'new') {

      let reply = await pumpb.fetchThis( data, '/confirm-ot')
      if (reply.done) {
        
        alert('เรียบร้อยค่ะ')
        pumpb.clearBrowserBar()
        location.reload()

      } else {
        alert('save ข้อมูลไม่ได้ค่ะ')
      }

    } else if (MODE == 'edit') {

      //
      alert('save in edit mode')

    } else {
      alert('not save in this mode')
    }
    
  } catch(er) {
    console.error( er)
    alert('มีปัญหาทางเทคนิคค่ะ ลองกด refresh หน้าจออีกทีดีมั๊ยคะ')
  }
}




function showStaff( callingElement ) {
  // upon user choosen a staff, shows staff name in the #showStaffHere

  let selectValue = callingElement.value
  if (!selectValue.startsWith('-')) {

    if (!selectValue.startsWith('ลบ')) {

      // this item is good to put into the box but need to check first if it didn't exist so we don't dup it

      if ([...document.querySelector('#showStaffHere').children].some( el => el.textContent == selectValue)) {
        return
        // because it's the dup
      }

      let newSpan = document.createElement('span')
      newSpan.textContent = callingElement.value
      newSpan.className = 'w3-tag'
      newSpan.style.borderRadius = '10px'
      newSpan.style.margin = '2px'
      newSpan.style.fontSize = '1rem'
      document.querySelector('#showStaffHere').append(newSpan)

    } else if (selectValue == 'ลบอันหลังสุด') {

      let elem = document.querySelector('#showStaffHere')
      let leng = elem.children.length
      if (leng) {
        elem.children[ leng - 1].remove()
        document.querySelector('#selectStaff').selectedIndex = 0
      }

    } else if (selectValue == 'ลบทั้งหมด') {

      document.querySelector('#showStaffHere').innerHTML = ''
      document.querySelector('#selectStaff').selectedIndex = 0

    }
    

  }

  
}











</script>
</body>
</html>
  
