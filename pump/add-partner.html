<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Add Partner</title>
  <script src="conf.js"></script>
  <script src="pump-b.js"></script>
  <script src="/js/xdev-b.js"></script>
  <link href="/js/w3.css" rel="stylesheet" type="text/css">
  <link href="/js/material-x.css" rel="stylesheet" type="text/css">

<style>
  *,
  *::before,
  *::after { box-sizing: border-box; }
  html { font-size: 16px; }
  small { font-size: 0.8rem }
  label { font-size: 1.0rem }
  .medium { font-size: 1.0rem }
  .default { font-size: 1.25rem }
  .large { font-size: 1.5rem }
  .xlarge { font-size: 2.0rem }

  .world-space { max-width: 800px; margin: 0 auto 60px auto; }
  .my-form > input {
    width: 100%; padding: 4px;
  }
  .my-form input,
  .my-form textarea,
  .my-form select,
  .my-form option {
    font-size: 1.25rem;
  }

  .line-in-form {
   grid-column: span 2; width: 100%; border-top: 1px solid gray; margin: 16px 0;
  }

  .hover-it:hover { background-color: #b2ebf2;}

</style>
</head>
<body>

<!--h3 style="padding: 16px; color: blue; background-color: white; position: sticky; top: 0; z-index: 50">ป้อนข้อมูล Partner</h3-->


<div class="world-space" style="padding: 0 16px;">
  

  <div style="margin-bottom: 24px;">
    <div id="pageName" style="color: blue; background-color: white; z-index: 50; font-size: 1.5rem; font-style: bold">เพิ่ม Partner</div>
  
    <p class="tiny grey">Partner หมายถึงคู่ค้า ทั้งหมด จะเป็นลูกค้าก็ได้ หรือผู้ที่ทำธุรกิจกับเราก็ได้</p>
  </div>


  <!-- top action -->
  <div id="topActBox" style="display: none; align-items: center; justify-content: space-around; margin-bottom: 24px;">
    <button class="w3-button" style="padding: 4px 8px; background-color: #fdd835;" 
    onclick="editPartner()">Edit</button>
    <button class="w3-button" style="padding: 4px 8px; background-color: #757575;" disabled>Delete</button>
  </div>



  <!-- form -->
  <div class="my-form" id="add_new_staff_form" style="display: grid; grid-template-columns: 30% 70%; align-items: center; gap: 4px">

    <label>ภาพ</label>
    <div>
      <div style="cursor: pointer;" onclick="this.children[0].click()">
        <input type="file" id="picFile" hidden 
          onchange="xb.readPicFileAsDataUrl( this).then( durl => showPicHere.src = durl); showPicHere.hidden = false;">
        <div class="hover-it" style="display: inline-block; padding-right: 8px;">
          <img src="/icon-x/Image.svg" width="32">
          <small style="color: #5c6bc0">เลือกรูป</small>
        </div>
      </div>
      <img id="showPicHere" hidden
      style="width: 100%; object-fit: cover;">
    </div>


    <label>Code</label>
    <input type="text" id="code" placeholder="เช่น PTT">
    <label>ชื่อ*</label>
    <input type="text" id="name" placeholder="ชื่อจดทะเบียน">  
    <label>งาน / ธุรกิจที่ทำ</label>
    <textarea id="business" rows="3" placeholder="เช่น ขนส่งน้ำมัน ..."></textarea>

    <hr class="line-in-form">
      
    <label>โทร*</label>
    <input type="text" id="tel">  

    <label>Email</label>
    <input type="email" id="email">
    <label>Web</label>
    <input type="text" id="web">
    <label>Social App</label>
    <input type="text" id="socialApp" placeholder="เช่น line:@john">

    <hr class="line-in-form">



    <label>ประเภทองค์กร*</label>
    <!--input type="text" id="department"-->
    <select id="registerType" class="w3-select">
      <option>-----</option>
      <option>นิติบุคคล</option>
      <option>บุคคลธรรมดา</option>
      <option>กลุ่มบุคคล</option>
      <option>อื่นๆ</option>
    </select>  

    
    <label>ที่อยู่*</label>
    <textarea id="address" rows="3" placeholder="ตามทะเบียน"></textarea>
    <label>เลขทะเบียน</label>
    <input type="text" id="registerCode" placeholder="หรือเลขบัตร ปชช.">
    <label>เลขภาษี*</label>
    <input type="text" id="taxId" placeholder="หรือเลขบัตร ปชช.">

    <hr class="line-in-form">

    <label>Credit Score</label>
    <select class="w3-select" id="creditScore">
      <option>-----</option>
      <option>0 = ไม่ดีเลย</option>
      <option>1 = ไม่ค่อยดี</option>
      <option>2 = พอใช้</option>
      <option>3 = ทั่วไป</option>
      <option>4 = ดี</option>
      <option>5 = ดีมาก</option>
    </select>
    <label></label>
    <small>การจัดระดับความน่าเชื่อถือทางการเงิน จาก 0 ไม่มีเลย ไปถึง 5 ดีที่สุด (อันนี้อาจทำในอนาคต ต้องดูข้อมูลไประยะนึงก่อน)</small>

    <hr class="line-in-form">

    <label>บัญชีธนาคาร 1</label>
    <input type="text" id="bankAccount1" placeholder="เช่น กสิกร/123456">
    <label>บัญชีธนาคาร 2</label>
    <input type="text" id="bankAccount2">
    


    <hr class="line-in-form">

    <label>ผู้ติดต่อด้านการเงิน</label>
    <input type="text" id="financePerson" placeholder="เช่น คุณ กขค/213456">
    <label>ผู้ติดต่อด้านการขาย</label>
    <input type="text" id="salesPerson">
    <label>ผู้ติดต่อด้านการบริการ</label>
    <input type="text" id="servicesPerson">
    <label>ผู้ติดต่อด้านอื่นๆ</label>
    <input type="text" id="otherPerson">

    <hr class="line-in-form">



    <label>Note</label>
    <textarea id="note" rows="4" placeholder="Note ที่เรามีต่อเขา ..."></textarea>
    
    <label>ป้อนข้อมูลโดย*</label>
    <input id="enterBy" type="text" placeholder="เช่น @sern, @john ...">

  </div>



  <!-- form action -->
  <div id="formActBox" style="display: flex; align-items: center; justify-content: space-around; margin-top: 40px; margin-bottom: 60px;">
    <button class="w3-button w3-blue" 
    onclick="addPartner()">Save</button>
    <button class="w3-button w3-light-grey" 
    onclick="location.reload()">Cancel / Clear</button>
  </div>



</div>



<!-- u turn -->
<div style="padding: 4px; position: fixed; left: 0; bottom: 0; ">
  <img src="/icon/u-turn.svg" style="cursor: pointer; width: 32px;" 
  onclick="history.back()">
</div>


<script>
///////////////////////////////////////////////////////////////////


let MODE = 'new'
let PARTNER_ID;


// this code scroll page to top after reload
window.onload = () => {

  setTimeout( () => {
    window.scrollTo(0,0)
  }, 10)



  // check mode: view|edit ---------------------------------------
  const urlParams = new URLSearchParams(window.location.search)
  const partnerId = urlParams.get('partnerId')
  const mode = urlParams.get('mode')

  if (mode == 'view' && partnerId) {
    //alert('this is view mode for id=' + partnerId)

    try {

      pumpb.fetchThis( null, '/find-partner?id=' + partnerId, 'get')
      .then( reply => {

        if (reply.done) {
          //console.log( reply)
          //alert('got partner data')

          let data = reply.data
          document.querySelector('#showPicHere').src = data.pic || ''
          document.querySelector('#code').value = data.code || ''
          document.querySelector('#name').value = data.name || ''
          document.querySelector('#business').value = data.business || ''
          document.querySelector('#tel').value = data.tel || ''
          document.querySelector('#email').value = data.email || ''
          document.querySelector('#web').value = data.web || ''
          document.querySelector('#socialApp').value = data.socialApp || ''
          document.querySelector('#registerType').value = data.registerType || ''
          document.querySelector('#address').value = data.address || ''
          document.querySelector('#registerCode').value = data.registerCode || ''
          document.querySelector('#taxId').value = data.taxId || ''
          document.querySelector('#creditScore').value = data.creditScore || ''
          document.querySelector('#bankAccount1').value = data.bankAccount1 || ''
          document.querySelector('#bankAccount2').value = data.bankAccount2 || ''
          document.querySelector('#financePerson').value = data.financePerson || ''
          document.querySelector('#salesPerson').value = data.salesPerson || ''
          document.querySelector('#servicesPerson').value = data.servicesPerson || ''
          document.querySelector('#otherPerson').value = data.otherPerson || ''
          document.querySelector('#note').value = data.note || ''
          document.querySelector('#enterBy').value = data.enterBy || ''

          // disable, enable controls
          document.querySelector('#formActBox').style.display = 'none'
          document.querySelector('#topActBox').style.display = 'flex'
          
          document.querySelectorAll('input').forEach( el => {
            el.disabled = true
          })

          document.querySelectorAll('textarea').forEach( el => {
            el.disabled = true
          })

          document.querySelectorAll('select').forEach( el => {
            el.disabled = true
          })

          MODE = 'view'
          PARTNER_ID = partnerId
          document.querySelector('#pageName').textContent = 'ข้อมูล Partner'

          pumpb.clearBrowserBar()


        
        } else {
          alert('ไม่มีข้อมูล Partner รายนี้เลยค่ะ')
        }
  
      })

    } catch(er) {
      console.log(er)
      alert('มีปัญหาทางเทคนิคค่ะ')
    }

  }








}



// DEFINITION

const domain = PUMP_DOMAIN //'http://192.168.1.111:4000';
const showPicHere = document.getElementById('showPicHere');


//const lastEdit = new Date
//document.getElementById('lastEdit').value = lastEdit





async function fetchThis( data, api ) {
    
  let response = await fetch( domain + api, {
    method  : 'POST',
    headers : {'Content-Type':'application/json'},
    body    : JSON.stringify( data )

  })
  
  return response.json()

}


async function addPartner() {
  try {
    let data = {
      pic: showPicHere.src,
      code: document.getElementById('code').value,
      name: document.getElementById('name').value,
      business: document.getElementById('business').value,

      tel: document.getElementById('tel').value,
      email: document.getElementById('email').value,
      web: document.getElementById('web').value,
      socialApp: document.getElementById('socialApp').value,

      registerType: document.getElementById('registerType').value,
      address: document.getElementById('address').value,
      registerCode: document.getElementById('registerCode').value,
      taxId: document.getElementById('taxId').value,  

      creditScore: document.getElementById('creditScore').value,
      
      bankAccount1: document.getElementById('bankAccount1').value,
      bankAccount2: document.getElementById('bankAccount2').value,

      financePerson: document.getElementById('financePerson').value,
      salesPerson: document.getElementById('salesPerson').value,
      servicesPerson: document.getElementById('servicesPerson').value,
      otherPerson: document.getElementById('otherPerson').value,

      note: document.getElementById('note').value,
      enterBy: document.getElementById('enterBy').value,
      time: Date.now()
    }


    // validate
    if( !data.name || !data.tel || !data.address || !data.taxId || !data.enterBy || data.registerType.startsWith('-')) {
      alert('ช่องที่มีเครื่องหมาย * ต้องมีข้อมูล')
      return
    }


    // pass - basic validation

    let reply;
    if (MODE == 'new') {
      reply = await fetchThis( data, '/add-partner' )

    } else if (MODE == 'edit') {
      data._id = PARTNER_ID
      reply = await fetchThis( data, '/update-partner' )

    }


    if (reply.done) {
      alert(`เรียบร้อยค่ะ`)
      location.reload()
    } else {
      alert(`ไม่สามารถ Save ข้อมูลได้ค่ะ โปรดลองอีกครั้ง`)
    }
    

  
  } catch( error ) {
    console.error( error )
    alert('มีปัญหาทางเทคนิคค่ะ')
  }
}



function editPartner() {
  // enable all inputs to allow user edit, as well as controls

  document.querySelector('#formActBox').style.display = 'flex'
  document.querySelector('#topActBox').style.display = 'none'
  
  document.querySelectorAll('input').forEach( el => {
    el.disabled = false
  })

  document.querySelectorAll('textarea').forEach( el => {
    el.disabled = false
  })

  document.querySelectorAll('select').forEach( el => {
    el.disabled = false
  })

  MODE = 'edit'
  document.querySelector('#pageName').textContent = 'แก้ไขข้อมูล Partner'

}





</script>
</body>
</html>