<!DOCTYPE html>
<html>
<head>
  <!--link rel="icon" type="image/x-icon" href="favicon.ico"-->
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>dev-skill find dev guys here</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link href="/js/w3.css" rel="stylesheet" type="text/css">
  <link href="/js/flat_design_colors_full.css" type="text/css">
  <link href="/js/projex.css" rel="stylesheet" type="text/css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.8/dist/purify.min.js"></script>
  <script src="config.js"></script>
  <script src="/js/xfetch.js"></script>
  <script src="/js/xdev-b.js"></script>
  <script src="/js/projex.js"></script>
  <style>
    p, li, span {font-family: "Open Sans", sans-serif; font-size: 135%}
    table { width: 100%; border-collapse: collapse;}
    tr,th,td { border: 1px solid white; }
    th { font-weight: normal; font-size: smaller;}
    a { color: blue; cursor: pointer; text-decoration: underline;}
  </style>
</head>
<body>




<!--userName-->
<code id="profile_display" style="position: fixed; top: 0; right: 4px" class="x-small mat-text-indigo">@guest</code>



<div id="main" class="w3-container" style="max-width: 800px; margin: 0 auto;">
  <!--we'll keep the appName always on the top of the page. The userName is fixed at the top-right corner-->

  
  

  <!--homeSpace ; the first seen before everything--------------------->
  <div id="home_space" class="x-mt32" hidden>

    <div style="display: grid; grid-template-columns: auto auto; gap: 8px">
      <div class="mat-red2 x-round-1 x-pointer" style="display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 120px;" onclick="showSpace( [skill_space])">
        <div class="x-center x-fz150">Skills</div>
        <div class="x-center">3,000</div>
      </div>
      <div class="mat-lime2 x-round-2 x-pointer" style="display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 120px;">
        <div class="x-center x-fz150">Jobs</div>
        <div class="x-center">500</div>
      </div>
      <div class="mat-indigo2 x-round-4 x-pointer" style="display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 120px;">
        <div class="x-center x-fz150">Projects</div>
        <div class="x-center">150</div>
      </div>
      <div class="mat-orange2 x-round-3 x-pointer" style="display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 120px;">
        <div class="x-center x-fz150">Funding</div>
        <div class="x-center">58</div>
      </div>      
    </div>

    <div id="home_alert">
      <div class="mat-text-indigo x-condensed x-mt24 x-fz120">ALERT</div>
      <ul style="display: grid; grid-template-columns: auto; gap: 10px; font-size: 120%">
        <li class="x-fz120"><a href="#">@john</a>, java script, mongoDb, html, css -- joined 1h ago <span class="w3-tag w3-small x-round w3-green">SKILL</span></li>
        <li class="x-fz120"><a href="#">@jane</a> joined company xyz -- 30min ago <span class="w3-tag w3-small x-round w3-orange">JOB</span></li>
        <li class="x-fz120"><a href="#">@devster</a> and <a href="#">@xyz</a> starts <a href="#">smart farm project</a> -- may 21 <span class="w3-tag w3-small w3-blue x-round">PROJECT</span></li>
      </ul>
    </div>

    <div id="home_act" class="x-mt40">
      <div>
        <button class="w3-button w3-ripple w3-pink" onclick="showSpace([ login_space ]); login_profileName.focus()">Log-in</button>
        <button class="w3-button w3-ripple w3-teal" onclick="showSpace([ signup_space ]); signup_profileName.focus()">Sign-up</button>
      </div>
    </div>

  </div>



  <!--skill space ; everything about skills------------------------->
  <div id="skill_space">

    <!--appName-->
    <div class="x-mt32 x-mb40">
      <h2 class="x-center gloria x-mb0" style="color: darkred">dev-skill <span id="version_display" class="x-small w3-tag x-round"></span></h2>
      <div class="x-center x-gray x-italic x-serif">Find all the dev guys here 8-D</div>
    </div>
    


    <!--search box-->
    <div id="search_box" class="x-mt32">

      <div style="display: grid; grid-template-columns: 80% 20%; align-items: center;">
        <input id="search_word" type="text" class="w3-input w3-border x-round-14 x-fz135" placeholder="javasc, html, ..." onkeydown="if(event.key === 'Enter') findSkill()">
        <button class="w3-button w3-blue w3-ripple x-round-23 x-fz135" onclick="findSkill()">
          <img src="/icon/search.svg">
        </button>
      </div>
      
      
      <p class="x-small x-pointer x-mt24 mat-text-indigo"><img id="option_sign" src="/icon/off.svg" class="x-wh32"  onclick="toggleOption()"> option (not now)</p>
     

      <!--option-->
      <div id="search_option" class="x-background x-p" style="padding-top: 4px" hidden>
        <div style="display: grid; grid-template-columns: auto;" class="x-fz120">
          <label class="x-condensed mat-text-indigo">LOCATION</label>
          <input type="text" class="w3-input w3-border" placeholder="thai, singapore">
          <label class="x-condensed x-mt8 mat-text-indigo">EXPERIENCE</label>
          <select class="w3-select w3-border w3-white">
            <option>0-2 years</option>
            <option>2-5 years</option>
            <option>5-10 years</option>
            <option>10+ years</option>
          </select>
        </div>
      </div>
    </div>

    <!--search result-->
    <div id="result_div" class="x-fz120 x-mt24">

      <h6 class="mat-text-brown4 x-fz100"><i>what we found:</i></h6>
      <!--table id="search_result_table" class="">
        <tr><th class="x-condensed x-small">PROFILE</th><th class="x-condensed x-small">SKILL</th><th class="x-condensed x-small">AVAILABILITY</th></tr>
        <tr><td>--</td><td></td><td></td></tr>

        
      </table-->

      <table id="search_result_table" class="x-background x-fz105">
        <tr><th class="x-condensed x-small">PROFILE</th></tr>

        <tr><td class="x-p8">
          <div><a href="#">@sample</a> --avail: <span class="x-fz105">2 weeks</span></div>
          <div>java script, html, css, mongodb <span class="x-fz105">(5y)</span></div>
        </td></tr>
        <!--tr><td class="x-p8">
          <div><a href="#">@john</a> --avail: <span class="x-fz100">dicuss</span></div>
          <div>digital marketing</div>
        </td></tr>
        <tr><td class="x-p8">
          <div><a href="#">@jane</a> --avail: <span class="x-fz100">1 week</span></div>
          <div>html</div>
        </td></tr-->
      </table>

    </div>

    <!--skill_act_div-->
    <div id="skill_act_div" class="x-mtb32">
      <h6 class="mat-text-brown4"><i>what else you can do</i></h6>

      <div class="x-fz110 x-condensed" style="display: flex; flex-wrap: wrap; gap: 8px">

        <button id="login_button" class="w3-button w3-ripple w3-blue">Log-in</button>

        <button id="signup_button" class="w3-button w3-ripple mat-orange8">Sign-up</button>

        <button id="my_profile_button" class="w3-button w3-ripple mat-lime9" disabled>My Profile</button>

        <button id="logout_button" class="w3-button mat-grey6 w3-ripple" disabled>Log-out</button>

        <button id="reset_password_button" class="w3-button mat-deep-purple3 w3-ripple">Reset Password</button>
      </div>
    </div>
    <!--div style="height: 40px;"></div-->

    <!--u turn-->
    <!--div style="position: fixed; left: 0; bottom: 0" class="x-pointer x-p4" onclick="showSpace([ home_space ])">
      <img src="/svg/u-turn.svg" class="x-wh32">
    </div-->


    <!--info/about-->
    <div id="about" style="margin-top: 60px; margin-bottom: 30px; display: flex; align-items: center; gap: 24px">

      <div style="display: flex; gap: 4px; align-items: center; cursor: pointer" onclick="location.href = 'about.html';">
        <img src="/icon/info-o.svg" class="x-wh">
        <code class="x-small">About</code>
      </div>
      <div style="display: flex; gap: 4px; align-items: center; cursor: pointer" onclick="location.href = 'help.html';">
        <img src="/icon/page.svg" class="x-wh">
        <code class="x-small">Help</code>
      </div>
      <div style="display: flex; gap: 4px; align-items: center; cursor: pointer" onclick="showSpace([ contact_space ]);">
        <img src="/icon/mail.svg" class="x-wh">
        <code class="x-small">Contact</code>
      </div>
    </div>

  </div>








  <!--signup space---------------------------------------------------->

  <div id="signup_space" class="x-mt32" hidden>
    <h3 class="x-center x-darkred">sign-up</h3>
    <div style="line-height: 1.3" class="x-center x-fz100">sign-up เพื่อป้อนข้อมูล skill ของท่าน ไม่มีการเก็บข้อมูลส่วนตัวใดๆ</div>

    <div style="display: grid; grid-template-columns: auto; align-items: center;" class="x-mt32">
      <label class="x-condensed mat-text-indigo">PROFILE NAME *</label>
      <input id="signup_profileName" type="text" class="w3-input w3-border x-fz135" placeholder="a-zA-Z0-9_- only">
      <label class="x-mt x-condensed mat-text-indigo">PASSWORD * (min 8 chars)</label>
      <input id="signup_password" type="password" class="w3-input w3-border x-fz135">
      <label class="x-mt x-condensed mat-text-indigo">CONFIRM PASSWORD *</label>
      <input id="signup_password_repeat" type="password" class="w3-input w3-border x-fz135">
      <label class="x-mt x-condensed mat-text-indigo">PASSWORD HINT *</label>
      <input id="signup_password_hint" type="text" class="w3-input w3-border x-fz135" placeholder="ใช้ในการ reset password">
    </div>

    <div class="x-mt32 x-mb32 x-fz110">
      <button class="w3-button w3-ripple w3-blue x-condensed" 
      onclick="signupConfirm()">Confirm</button>

      <button class="w3-button w3-ripple x-condensed" onclick="showSpace([ skill_space]); signup_profileName.value=''; signup_password.value=''; signup_password_repeat.value = '';">Clear & Close</button>
    </div>
  </div>





  <!--login space-->
  <div id="login_space" class="x-mt32" hidden>
    <h3 class="x-center x-darkred">log-in</h3>
    <div style="line-height: 1.3" class="x-center x-fz100">log-in เพื่อแก้ไขข้อมูล skill และอื่นๆ</div>
    
    <div style="display: grid; grid-template-columns: auto;" class="x-mt32">
      <label class="x-condensed mat-text-indigo">PROFILE NAME *</label>
      <input id="login_profileName" type="text" class="w3-input w3-border x-fz135">
      <label class="x-mt x-condensed mat-text-indigo">PASSWORD *</label>
      <input id="login_password" type="password" class="w3-input w3-border x-fz135">
    </div>

    <div class="x-mtb32 x-fz110">
      <button class="w3-button w3-ripple x-condensed w3-blue" onclick="logIn()">Submit</button>
      <button class="w3-button w3-ripple x-condensed" onclick="showSpace([ skill_space ])">Clear & Close</button>
    </div>
  </div>



 




  <!--after login space----------------------------------------------->
  <div id="after_login_space" hidden>
    <h3 id="after_login_profileName" class="x-center x-mt32 x-darkred"></h3>
    <div class="x-center x-fz100" style="line-height: 1.3;">นี่เป็นข้อมูลใน skill profile ของคุณ คุณสามารถแก้ไขได้ เมื่อแก้เสร็จแล้ว กดปุ่ม Update</div>

    <div hidden><!--dashboard-->
      <div style="display: grid; grid-template-columns: auto auto; gap: 8px" class="x-mt24">
        <div class="x-round-1 w3-container mat-red2 x-pointer" onclick="after_login_space.hidden = true; who_view_space.hidden = false">
          <span class="x-fz100 x-condensed">VIEW</span>
          <h1>100</h1>
        </div>
        <div class="x-round-2 w3-container mat-orange2">
          <span class="x-fz100 x-condensed">CONTACT</span>
          <h1>8</h1>
        </div>
        <div class="w3-container mat-green2">
          <span class="x-fz100 x-condensed">JOBS</span>
          <h1>3</h1>
        </div>
        <div class="w3-container mat-blue2">
          <span class="x-fz100 x-condensed">DONE</span>
          <h1>25</h1>
        </div>
        <div class="x-round-34 w3-container mat-brown2 x-pb" style="grid-column: span 2">
          <span class="x-fz100 x-condensed">SATISFY</span>
          <div class="x-mtb">
            <img src="/icon/star-black.svg">
            <img src="/icon/star-black.svg">
            <img src="/icon/star-black.svg">
            <img src="/icon/star-black.svg">
            <img src="/icon/star-black.svg">
          </div>
        </div>
      </div>
    </div>
    

    <div class="x-mt32">
      <div class="mat-text-indigo x-condensed">MY BRIEF *</div>
      <p id="my_brief" class="x-fz135 x-mt0" contenteditable="true" oninput="after_update_button.disabled=false"></p>
    </div>


    <div class="x-mt32">
      <h6 class="mat-text-indigo x-condensed">MY SKILLS * (กดแช่ แล้วลากออก เพื่อลบ)</h6>
      <div id="skillContainer" style="display: flex; flex-wrap: wrap; gap: 8px; align-items: center;" class="x-fz100">
        
        <!--add icon-->
        <img id="add_skill_icon" src="/icon/plus-o.svg" class="x-wh24 x-pointer x-ml" onclick="add_skill_box.hidden=false; add_skill_field.focus()">

      </div>
    </div>

    <!--add skill-->
    <div id="add_skill_box" class="x-mt" hidden>
      <div style="display: grid; grid-template-columns: 75% 25%;" class="x-fz135">
        <input id="add_skill_field" type="text" class="w3-input w3-border" onkeyup="getSkill( this.value)">
        <button class="x-condensed w3-button w3-blue w3-ripple" onclick="addSkill( add_skill_field.value )">ADD</button>
      </div>
    </div>
   

    <div class="x-mt32">
      <h6 class="mat-text-indigo x-condensed x-mb0">MY EXPERIENCES (YEARS) *</h6>
      <input id="my_experience" type="number" class="w3-input w3-border x-fz135" onchange="after_update_button.disabled = false" placeholder="numbers only">
    </div>

    <div class="x-mt">
      <h6 class="mat-text-indigo x-condensed x-mb0">MY AVAILABILITY *</h6>
      <select id="my_availability" class="w3-select w3-border x-fz135" onchange="after_update_button.disabled = false">
        <option>now</option>
        <option>1 week notice</option>
        <option>2 weeks notice</option>
        <option>1 month notice</option>
        <option>discussion</option>
      </select>
    </div>


    <div class="x-mt">
      <h6 class="mat-text-indigo x-condensed x-mb0">LOCATION/CITY</h6>
      <input id="my_location" type="text" class="w3-input w3-border x-fz135" onchange="after_update_button.disabled = false" placeholder="Bangkok, Thailand">
    </div>

    <div class="x-mt">
      <h6 class="mat-text-indigo x-condensed x-mb0">NATIONALITY</h6>
      <input id="my_nationality" type="text" class="w3-input w3-border x-fz135" onchange="after_update_button.disabled = false" placeholder="Thai">
    </div>


    <!--action-->
    <div class="x-mtb32 x-fz110">
      <button id="after_update_button" class="w3-button w3-blue w3-ripple x-condensed" disabled 
      onclick="editProfile('update')">Update</button>

      <button id="after_close_button" class="w3-button w3-ripple x-condensed" onclick="showSpace([ skill_space ])">Close</button>
    </div>

  </div>
  



  <!--whoViewMyProfile----------------------------------------------->
  <div id="who_view_space" hidden>
    <h3 class="x-center">who view my profile</h3>
    <table style="font-size: 120%">
      <tr><th>who</th><th>time</th></tr>
      <tr><td>@elon</td><td>5/12 09:00</td></tr>
      <tr><td>@trump</td><td>5/16 12:45</td></tr>
      <tr><td>@putin</td><td>5/20 20:12</td></tr>
    </table>

    <div style="position: fixed; left: 0; bottom: 0" class="x-pointer x-p4" onclick="who_view_space.hidden = true; after_login_space.hidden = false">
      <img src="/icon/u-turn.svg" class="x-wh32">
    </div>
  </div>



  <!--reset password space------------------------------------------->
  <div id="reset_password_space" class="x-mt32" hidden>
    <h3 class="x-center x-darkred">reset password</h3>
    <div class="x-center x-fz100" style="line-height: 1.3;">ต้องมี password hint ด้วย ไม่งั้นจะไม่สามารถ reset ได้</div>

    <div class="x-mt32" style="display: grid; grid-template-columns: auto;">
      <label class="x-condensed mat-text-indigo">PROFILE NAME *</label>
      <input id="reset_profile_name" type="text" class="w3-input w3-border x-fz135">

      <label class="x-condensed mat-text-indigo x-mt">PASSWORD HINT *</label>
      <input id="reset_password_hint" type="text" class="w3-input w3-border x-fz135">

      <label class="x-condensed mat-text-indigo x-mt">NEW PASSWORD *</label>
      <input id="reset_new_password" type="password" class="w3-input w3-border x-fz135">
      
      <label class="x-condensed mat-text-indigo x-mt">REPEAT NEW PASSWORD *</label>
      <input id="reset_repeat_password" type="password" class="w3-input w3-border x-fz135">
    </div>
    <div class="x-mt32 x-fz110">
      <button class="w3-button w3-ripple w3-blue x-condensed" onclick="resetPassword()">Reset</button>

      <button class="w3-button w3-ripple x-condensed" onclick="showSpace([ contentSpace[1] ]); reset_password_hint.value = ''; reset_new_password.value = ''; reset_repeat_password.value = '';">Clear & Close</button>
    </div>
  </div>


  <!--contact space------------------------------------------------->
  <div id="contact_space" class="x-mt32" hidden>
    <h3 class="x-center x-darkred">contact us</h3>
    <div class="x-center x-fz100" style="line-height: 1.3;">สื่อสารกับเราได้ทุกเรื่อง จะแจ้งปัญหา เสนอแนะ หรือคุยเรื่องใดๆ ได้ทั้งหมด ตอนนี้ยังเป็นทางเดียวอยู่ ต่อไปน่าจะเป็นแบบ 2 ทางได้</div>

    <div class="x-mt32" style="display: grid; grid-template-columns: auto;">
      <label class="x-condensed mat-text-indigo">YOUR MESSAGE *</label>
      <textarea id="your_message" style="width: 100%; font-size: 135%" rows="5"></textarea>

      <label class="x-condensed mat-text-indigo x-mt">YOUR CONTACT (OPTION)</label>
      <input id="your_contact" type="text" class="w3-input w3-border x-fz135">
    </div>

    <div class="x-mt32 x-fz110">
      <button class="w3-button w3-ripple w3-blue x-condensed" onclick="sendContact()">Send</button>

      <button class="w3-button w3-ripple x-condensed" onclick="showSpace([ contentSpace[1] ]); your_message.value = '';">Clear & Close</button>
    </div>
  </div>




</div>
  
    




<!-- page act ---------------------------------------------------->
<!--div style="height: 48px"></div>
<div style="position: fixed; left: 0; bottom: 0;">
  <button class="w3-btn x-p8 w3-white" onclick="location.href='index.html';"><img src="/svg/u-turn.svg" width="32" height="32"></button>
</div-->

<script>
///////////////////////////////////////////////////////////////////
//main script

//xb.page.visitCount( nexWeb.nodeXurl + '/nex-web-visit-count', {
//  page: location.pathname, lastVisit: Date.now()
//})


//----------------------------------------------------------


version_display.innerHTML = conf.versionDisplay


const devsk = {
  about   : 'search dev guys here',
  version : 'beta',
  by      : 'nex-era',
  browserName: navigator.userAgent,
  language: navigator.languages,

  //loginProfile <--keep logged in profileName here, eg, john
  //loginCert <--keep loginCert from server
}

const contentSpace = [
  document.getElementById('home_space'), 
  document.getElementById('skill_space'), 
  document.getElementById('signup_space'), 
  document.getElementById('login_space'), 
  document.getElementById('after_login_space'), 
  document.getElementById('who_view_space'),
  document.getElementById('reset_password_space'),
  document.getElementById('contact_space')
]



//check session after reload
if (  sessionStorage.getItem('loginProfile') && 
      sessionStorage.getItem('loginCert')) {

  profile_display.textContent = '@' + sessionStorage.getItem('loginProfile')
  devsk.loginProfile = sessionStorage.getItem('loginProfile')
  devsk.loginCert = sessionStorage.getItem('loginCert')
  setAfterLoginButtonState()

  if ( sessionStorage.getItem('loginData')) {
    loadLoginData( JSON.parse( sessionStorage.getItem( 'loginData')))
  } else {
    alert('Your logged in data is lost. Please re log-in to get it.')
  }
}









//mobile touch init
//document.addEventListener("DOMContentLoaded", enableTouchDrag)
//let draggedSkill = null












//justPost
async function justPost( ur_l, dat_a, headerField) {
  /*
      default headers will be json but if you put to_ken, we'll add Authorization into it.
  */

  let setHeaders = {
    'Content-Type':'application/json'
  }

  if (headerField) {
    for (key in headerField) {
      setHeaders[ key.toLowerCase() ] = headerField[ key] 
    } 
  } 

  try {
    const resp = await fetch( ur_l, {
      method  : 'POST',
      headers : setHeaders,
      body    : JSON.stringify( dat_a)
    })

    if (!resp.ok) {
      const errorText = await resp.text()
      throw new Error(`fail, network error, ${resp.status}: ${errorText}`)
    }

    return await resp.json() //this is from where we fetched.
  
  } catch( error) {
    console.error( 'justPost', error )
    return {
      done  : false, 
      msg   : 'fail, fetch from server (3000)',
      attach: error, 
      from  : 'justPost'}
  }

  // tested=ok, @devster
}



//setAfterLoginButton----------------------------------------------
function setAfterLoginButtonState () {
  login_button.disabled           = true;
  signup_button.disabled          = true
  my_profile_button.disabled      = false
  logout_button.disabled          = false
  reset_password_button.disabled  = false
}








//signupConfirm---------------------------------------------------
async function signupConfirm() {
  //when user open sign-up form and click confirm

  //validate
  if (signup_profileName.value.length < 3 || signup_password.value.length < 8) {

    alert('Fail. Profile Name must >= 3 chars. | Password must >= 8 chars.')
    return
  }

  if (signup_password.value != signup_password_repeat.value) {
    alert('Fail. Password & Confirm Password mismatched.')
    return
  }

  if (!signup_password_hint.value) {
    alert('Fail. Please provide the Password Hint.')
    return
  }

  if ( badProfile( signup_profileName.value )) {
    //profileName invalid
    alert('Fail. The Profile Name allows for: a-zA-Z0-9_- only.')
    return
  }


  //let passHash = await px.hash256( signup_password.value)

  let signupResponse = await justPost(`${ conf.apiUrl }/devsk/sign-up`, { 
    profileName : signup_profileName.value,
    passwordHash: await px.hash256( signup_password.value ),
    passwordHint: await px.hash256( signup_password_hint.value )
  })

  if (signupResponse.done) {
    //take key values
    devsk.loginProfile  = signup_profileName.value
    devsk.loginCert     = signupResponse.loginCert

    showSpace([ after_login_space ])

    //clear after_login_space & signup_space
    resetAfterLoginSpace()
    after_login_profileName.textContent = '@' + devsk.loginProfile
    after_update_button.textContent = 'Add'
    after_update_button.setAttribute('onclick',"editProfile('add')")
    signup_profileName.value      = ''
    signup_password.value         = ''
    signup_password_repeat.value  = ''
    profile_display.textContent   = '@' + devsk.loginProfile
    my_brief.textContent          = 'Write here...'

    //select my_brief for user to get start editing her profile
    const range     = document.createRange()
    const selection = window.getSelection()
    range.selectNodeContents( my_brief)
    selection.removeAllRanges()
    selection.addRange( range)

    //set buttons
    login_button.disabled   = true
    signup_button.disabled  = true
    document.getElementById('after_close_button').disabled = true

    //tell user
    alert('Done. Your Sign-up is done.')


  } else {
    alert('ERROR: ' + signupResponse.msg)
  }
}



//showSpace---------------------------------------------------------
function showSpace( space_elem_array ) {
  // show this space but hide the rest


  contentSpace.forEach( sp => {
    if (space_elem_array.includes( sp )) {
      sp.hidden = false
    } else {
      sp.hidden = true
    }
  })
}




//logIn--------------------------------------------------------------
async function logIn() {

  //validate
  if (  login_profileName.value.length < 3 || 
        login_password.value.length < 8 || 
        badProfile( login_profileName.value )) {
  
          alert('Profile Name must be 3 chars min. | Password must be 8 chars min. | the Profile Name must be a-zA-Z0-9_- only')
          return
  }

  //main
  let loginApproval = await justPost( conf.apiUrl + '/devsk/log-in', {
    profileName : clean( login_profileName.value ),
    passwordHash: await px.hash256( login_password.value)
  })

  // loginApproval => {done: true|false, msg: '....', from: ...}
  if (loginApproval.done) {
    //alert( 'done / ' + loginApproval.msg)
    devsk.loginProfile          = login_profileName.value
    devsk.loginCert             = loginApproval.loginCert
    profile_display.textContent = '@' + devsk.loginProfile
    sessionStorage.setItem('loginProfile', devsk.loginProfile)
    sessionStorage.setItem('loginCert', devsk.loginCert)
    sessionStorage.setItem('loginData', 
      JSON.stringify( loginApproval.attach)
    )

    //clear the log-in form
    //login_profileName.value = ''
    //login_password.value = ''

    //open home page for logged in user
    showSpace([ after_login_space ])
    after_login_profileName.textContent = '@' + devsk.loginProfile

    my_brief.textContent  = loginApproval.attach.brief
    my_experience.value   = loginApproval.attach.experience 
    my_availability.value = loginApproval.attach.availability
    my_location.value     = loginApproval.attach.location
    my_nationality.value  = loginApproval.attach.nationality

    let skillList = loginApproval.attach.skill.split(',').map(v => v.trim())

    skillList.forEach( sk => {
      let skTag = getSkillTag( sk)
      skillContainer.insertBefore( skTag, add_skill_icon)
    })

    after_update_button.textContent = 'Update'
    after_update_button.setAttribute('onclick',"editProfile('update')")
    after_update_button.disabled = true

    //main buttons
    login_button.disabled       = true
    signup_button.disabled      = true
    my_profile_button.disabled  = false //on the skill_space
    logout_button.disabled      = false

  } else {
    alert( 'ERROR: ' + loginApproval.msg)
  }
 
}


//loadLoginData-----------------------------------------------------
function loadLoginData( LOGIN_DATA ) {
  //showSpace([ after_login_space ])
  after_login_profileName.textContent = '@' + devsk.loginProfile
  my_brief.textContent  = LOGIN_DATA.brief
  my_experience.value   = LOGIN_DATA.experience 
  my_availability.value = LOGIN_DATA.availability
  my_location.value     = LOGIN_DATA.location
  my_nationality.value  = LOGIN_DATA.nationality

  let skillList = LOGIN_DATA.skill.split(',').map(v => v.trim())

  skillList.forEach( sk => {
    let skTag = getSkillTag( sk)
    skillContainer.insertBefore( skTag, add_skill_icon)
  })
}




// ensure all contents loaded before calling -------------------
// skill space act ; main act
document.addEventListener('DOMContentLoaded', function() {

  const loginBtn = document.getElementById('login_button')
  const signupBtn = document.getElementById('signup_button')
  const myProfileBtn = document.getElementById('my_profile_button')
  const logoutBtn = document.getElementById('logout_button')
  const resetPasswordBtn = document.getElementById('reset_password_button')

  if (loginBtn) {
    loginBtn.addEventListener('click', function() {
      showSpace([ contentSpace[3] ])
      //const login_profileName = document.getElementById('login_profileName')
      //if (login_profileName) login_profileName.focus()
    })
  }
  if (signupBtn) {
    signupBtn.addEventListener('click', () => {
      showSpace([ contentSpace[2] ])
      //const signup_profileName = document.getElementById('signup_profileName')
      //if (signup_profileName) signup_profileName.focus()
    })
  }
  if (myProfileBtn) {
    myProfileBtn.addEventListener('click', () => {
      showSpace([ contentSpace[4] ])
    })
  }
  if (logoutBtn) {
    logoutBtn.addEventListener('click', logOut)
  }
  if (resetPasswordBtn) {
    resetPasswordBtn.addEventListener('click', () => {
      showSpace([ contentSpace[6] ])
      //document.getElementById('reset_profile_name').focus()
    })
  }

  enableTouchDrag()

})







//----------------------------------------------------------------
//func for mobile touch handling

let draggedSkill      = null
let cloneSkill        = null
let startX            = 0
let startY            = 0
let originalContainer = null

// Initialize touch drag functionality
function enableTouchDrag() {
  const skills = document.querySelectorAll(".skill");
  skills.forEach(skill => {
    skill.addEventListener("touchstart", touchStartHandler);
    skill.addEventListener("touchmove", touchMoveHandler);
    skill.addEventListener("touchend", touchEndHandler);
  });
}

//let draggedSkill = null;

function touchStartHandler(event) {
  draggedSkill  = event.target;
  startX        = event.touches[0].clientX;
  startY        = event.touches[0].clientY;

  // Create a clone for visual dragging
  cloneSkill = draggedSkill.cloneNode(true);
  cloneSkill.style.position       = "absolute";
  cloneSkill.style.left           = `${startX}px`;
  cloneSkill.style.top            = `${startY}px`;
  cloneSkill.style.opacity        = "0.7";
  cloneSkill.style.pointerEvents  = "none";
  cloneSkill.style.transition     = "opacity 0.2s";
  cloneSkill.style.zIndex = "1000";
  document.body.appendChild(cloneSkill);

  // Hide the original skill (for clean UI)
  draggedSkill.style.opacity = "0";
  draggedSkill.style.visibility = "hidden"; // Make sure it is hidden
}

function touchMoveHandler(event) {
  if (cloneSkill) {
      const touch = event.touches[0];
      cloneSkill.style.left = `${touch.clientX - cloneSkill.clientWidth / 2}px`;
      cloneSkill.style.top = `${touch.clientY - cloneSkill.clientHeight / 2}px`;
    }
}

function touchEndHandler(event) {
  if (cloneSkill) {
    // Check if dropped inside the container
    const container = document.getElementById("skillContainer");
    const containerRect = container.getBoundingClientRect();
    const touch = event.changedTouches[0];
    const isInsideContainer =
      touch.clientX >= containerRect.left &&
      touch.clientX <= containerRect.right &&
      touch.clientY >= containerRect.top &&
      touch.clientY <= containerRect.bottom;

    // Remove the clone
    cloneSkill.remove();
    cloneSkill = null;

    if (isInsideContainer) {
      // Restore the original skill
      draggedSkill.style.opacity = "1";
      draggedSkill.style.visibility = "visible";
    } else {
      // Ensure the original is removed completely
      draggedSkill.remove();
      draggedSkill = null; // Clear reference to avoid memory leak
      after_update_button.disabled = false
    }
  }
}



//getSkillTag-----------------------------------------------------------
function getSkillTag( skill_name) {

  /*yaml

  for   : make the input skill_name as a w3-tag style and return
  input : string of skill name
  output: <span> with proper decoration

  */

  let newSkillTag = document.createElement('span')
  newSkillTag.className = "skill w3-tag w3-round-xlarge x-pointer x-fz120"
  newSkillTag.setAttribute('draggable',"true")
  newSkillTag.setAttribute('ondragend',"removeSkill(event, this)")
  newSkillTag.textContent = skill_name

  return newSkillTag
}


//resetAfterLoginSpace
function resetAfterLoginSpace() {

  after_login_profileName.textContent = ''
  my_brief.textContent      = ''
  skillContainer.innerHTML  = `<img id="add_skill_icon" src="/icon/plus-o.svg" class="x-wh24 x-pointer x-ml" onclick="add_skill_box.hidden=false; add_skill_field.focus()">`
  my_experience.value   = ''
  my_availability.value = ''
  my_location.value     = ''
  my_nationality.value  = ''
  after_update_button.textContent = 'Update'
  after_update_button.setAttribute('onclick',"editProfile('update')")
}



//findSkill---------------------------------------------------------
async function findSkill() {

  if (search_word.value.trim() != '') {
    let foundGuys = await justPost(conf.apiUrl + '/devsk/find', 
      { skill: search_word.value }
    )

    let resultTable = document.getElementById('search_result_table')

    if (foundGuys.length) {

      //delete exam row in table
      //search_result_table.innerHTML = '<tr><th class="x-condensed x-small">PROFILE</th><th class="x-condensed x-small">SKILL</th><th class="x-condensed x-small">AVAILABILITY</th></tr>'
      //let tableLastRow = resultTable.rows[ resultTable.rows.length - 1]

      //if (tableLastRow) {
        //resultTable.deleteRow( resultTable.rows.length - 1)
      //}

      resultTable.innerHTML = '<tr><th class="x-condensed x-small">PROFILE</th></tr>'

      //make each row
      foundGuys.forEach( guy => {
        let newTr = document.createElement('tr')
        
        newTr.innerHTML = `<td class="x-p8">
          <div><a href="${conf.apiUrl}/devsk/prof/@${encodeURIComponent( clean(guy.profileName) )}">@${ clean( guy.profileName )}</a> --avail: <span class="x-fz105">${ clean( guy.availability )}</span></div>
          <div>${ clean( guy.skill )} <span class="x-fz105">${ '(' + clean( guy.experience ) + 'y)'}</span>
        </td>`

        search_result_table.append( newTr)
      })

    } else {
      //if not found the server replies with false
      resultTable.innerHTML = `<tr><th>profile</th></tr>
      <tr><td style="padding: 16px 8px">-- not found</td></tr>`
    }
  }
}


//------------------------------------------------------------------


//toggleOption
function toggleOption() {
  if (option_sign.src.includes('off')) {
    //search_option.hidden = false
    option_sign.src = "/icon/switch-on.svg"
  } else {
    //search_option.hidden = true
    option_sign.src = "/icon/off.svg"
  }
}

//removeSkill
function removeSkill( event, elem) {
  const container = document.getElementById('skillContainer')
  const containerRect = container.getBoundingClientRect()
  const mouseX = event.clientX
  const mouseY = event.clientY

  if (
    mouseX < containerRect.left ||  
    mouseX > containerRect.right ||
    mouseY < containerRect.top || 
    mouseY > containerRect.bottom) {
    elem.remove()
    after_update_button.disabled = false
  }
}

//getSkill
function getSkill( input_skill) {

  if ( input_skill == '') {
    return
  }

  clearTimeout( devsk.addTimer)        
  devsk.addTimer = setTimeout( f => {
    let matched = skillData.find(v => v.skill.match( eval('/' + input_skill + '/i') ))
  
    if (matched) {
      add_skill_field.value = matched.skill
    }
  }, 1000)
}

//addSkill
function addSkill( new_skill ) {
  
  if ( hasTag( new_skill) ) {
    alert('This is invalid')
    return
  }

  let newSpan = document.createElement('span')
  newSpan.className = "w3-tag w3-round-xlarge x-pointer x-fz120"
  newSpan.setAttribute('ondragend',"removeSkill(event, this)")
  newSpan.setAttribute('draggable','true')
  newSpan.textContent = new_skill
  skillContainer.insertBefore( newSpan, add_skill_icon)

  //hide the add_skill_box, reset add_skill_field
  add_skill_box.hidden = true
  add_skill_field.value = ''
  after_update_button.disabled = false
}


//editProfile--------------------------------------------------------
async function editProfile( mode='update' ) {

  /*yaml

  for   : this func for the after_login_space where user can edit her own profile. But the func has 2 modes, update and add. The default button in after_login_space is Update but after sign-up the button changes to Add.

  input : when user clicks Update or Add buttons in the after_login_space
  output: 
    - calls /devsk/edit-profile for Update
    - calls /devsk/add-profile for Add

  */

  //update the profile to server
  let dataToUpdate = {
    profileName : after_login_profileName.textContent.slice(1),
    brief       : my_brief.textContent,
    skill       : Array.from( xb.at([ skillContainer, {all:'span'} ]) ).map(v => v.textContent).join().replaceAll(',',', '),
    experience  : my_experience.value,
    availability: my_availability.value,
    location    : my_location.value,
    nationality : my_nationality.value
  }

  //validate
  if (  !dataToUpdate.profileName || !devsk.loginCert ||
        badProfile( dataToUpdate.profileName ) ||
        badUuid( devsk.loginCert) ) {

          alert('Fail. Profile Name is incorrect. | Please log-in first.')
          return
  }  
  
  for (ky in dataToUpdate) {
    if ( hasTag( dataToUpdate[ky] )) {
      alert('Fail. Field ' + ky + ' is invalid (5000)')
      return
    }
  }


  //main of update
  if (mode == 'update') {

    if ( !devsk.loginCert || badUuid( devsk.loginCert)) {
      alert('Fail. You have to log-in first.')
      return
    }

    let serverReply = await justPost( 
      conf.apiUrl + '/devsk/edit-profile', 
      dataToUpdate,
      { logincert: devsk.loginCert } //header
    )

    if (serverReply.done) {
      alert('Done. Your profile is updated.')
      after_update_button.disabled = true

    } else {
      alert('ERROR: ' + serverReply.msg)
    }



  } else if (mode == 'add') {

    //validate
    if (  my_brief.textContent  == '' || 
          xb.at([ skillContainer, {all:'span'} ]).length == 0 || my_experience.value   == '' || 
          my_availability.value == '' ) {

      alert('Fail. Please complete all the * fields.')
      return
    }

    //validate
    for (ky in dataToUpdate) {
      if ( hasTag( dataToUpdate[ky] )) {
        alert('Fail. Field ' + ky + ' is invalid (5000)')
        return
      }
    }

    //main of add
    let serverReply = await justPost( 
      conf.apiUrl + '/devsk/add-profile', 
      dataToUpdate, 
      { logincert: devsk.loginCert } 
    )


    if (serverReply.done) {
      alert('Done. Your profile is added.')

      //then change button label to 'Update' and disable it
      after_update_button.textContent = 'Update'
      after_update_button.setAttribute('onlick',"editProfile('update')")
      after_update_button.disabled = true
      after_close_button.disabled = false //so user can close and get back to home

      //set main buttons
      my_profile_button.disabled = false //on skill_space
      logout_button.disabled = false

    } else {
      alert('ERROR: ' + serverReply.msg)
    }

  }
  
}





//resetPassword------------------------------------------------------
async function resetPassword() {

  //validate
  if (  !reset_profile_name || !reset_password_hint.value || 
        !reset_new_password.value || !reset_repeat_password ||
        !(reset_new_password.value.length > 7) || 
        badProfile( reset_profile_name.value)) {

    alert('Please complete all the * fields. | Minimum password is 8 characters. | The Profile Name is allowed for: a-zA-Z0-9_- only.')
    return
  }

  if (reset_new_password.value != reset_repeat_password.value) {
    alert('The New Password must as same as the Repeat New Password')
    return
  }

  if ( badProfile( reset_profile_name.value )) {
    alert('Invalid Profile Name')
    return
  }

  //main
  let serverReply = await justPost( 
    conf.apiUrl + '/devsk/reset-password', 
    {
      profileName     : reset_profile_name.value,
      passwordHint    : await px.hash256( reset_password_hint.value ),
      newPasswordHash : await px.hash256( reset_new_password.value )
    }
  )

  if (serverReply.done) {
    alert( 'Done. Your password is reset.')
    showSpace([ contentSpace[1] ])
  } else {
    alert( 'ERROR: ' + serverReply.msg)
  }

  
}



//sendContact--------------------------------------------------------
async function sendContact() {
  /*
    data: your_message , your_contact
    sendTo: /devsk/contact
  */

  let yourMsg = document.getElementById('your_message').value
  let yourContact = document.getElementById('your_contact').value

  //validate
  if (!yourMsg) {
    alert('Fail.Please put your message.')
    return
  }

  if ( hasTag( yourMsg) || hasTag( yourContact) ) {
    alert('Fail. The html tag or code is not allowed in your message.')
    return
  }



  /*
    1. send message to $node-x/devsk/contact

  */

  let serverReply = await justPost( conf.apiUrl + '/devsk/contact', {
    yourMsg : yourMsg,
    from    : yourContact
  })

  if (serverReply.done) {
    alert('Done. your message sent to the admin.')
    showSpace([ skill_space ])
  } else {
    alert('ERROR: ' + serverReply.msg)
  }
}


//-----------------------------------------------------------------


//clean -- clean before put in html
function clean( STRING ) {
  return DOMPurify.sanitize( STRING, 
    /*{
      ALLOWED_TAGE: [],
      ALLOWED_ATTR: []
    }*/
  )
}


//hasTag --check if there's html tag in the STRING
function hasTag( STRING ) {
  return /<[^>]+>/.test( STRING )
}


//badProfile
function badProfile( PROFILE_NAME ) {
  return !/^[\w-]{3,}$/.test( PROFILE_NAME )
}



//badUuid
function badUuid( UUID_STRING ) {
  return !/\b[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}\b/i.test( UUID_STRING)
}



//logOut------------------------------------------------------------
async function logOut() {
  /* 
    brief : send loginProfile & loginCert to devsk
    rule  : user has to log-in before be able to log-out
    logic : 
      - validate B loginProfile, loginCert
      - send to devsk
      - clear devsk.loginProfile, devsk.loginCert, reload page
  */

  //validate
  if (  badProfile( devsk.loginProfile ) || 
        badUuid( devsk.loginCert )) {

          alert('Fail. You have not log-in yet. | Something happens to your browser.')
          return
  }


  let logoutApprove = await justPost( conf.apiUrl + '/devsk/log-out', 
    { profileName : devsk.loginProfile },
    { logincert   : devsk.loginCert } //header
  )

  if (logoutApprove.done) {
    alert('Done. You are now logged out. See you soon :-)')
    sessionStorage.clear()
    location.reload()
  } else {
    alert('ERROR: ' + logoutApprove.msg)
  }
}






// heavy load stuff------------------------------------------------

//get skill data ; this is the poke already
let skillData
justPost( conf.apiUrl + '/nexdb-find', 
  { collection: 'skill', query: {} }
).then( data => skillData = data)






</script>

</body>
</html>